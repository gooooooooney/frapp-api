<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶è¯­éŸ³è¯†åˆ«ç³»ç»Ÿ</title>
    <script  crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_c29saWQtaHVza3ktODIuY2xlcmsuYWNjb3VudHMuZGV2JA"
    src="https://unpkg.com/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>
    <!-- Clerk SDK è‡ªåŠ¨æ£€æµ‹é…ç½® -->
    <script>
        // è‡ªåŠ¨æ£€æµ‹Clerké…ç½®
        function detectClerkConfiguration() {
            // æŸ¥æ‰¾é¡µé¢ä¸­çš„Clerkè„šæœ¬æ ‡ç­¾
            const clerkScripts = document.querySelectorAll('script[data-clerk-publishable-key]');
            
            if (clerkScripts.length > 0) {
                const clerkScript = clerkScripts[0];
                const publishableKey = clerkScript.getAttribute('data-clerk-publishable-key');
                
                if (publishableKey && publishableKey.startsWith('pk_')) {
                    window.clerkAvailable = true;
                    window.detectedClerkKey = publishableKey;
                    console.log(`Clerk SDK: æ£€æµ‹åˆ°æœ‰æ•ˆé…ç½®ï¼ŒKey: ${publishableKey.substring(0, 20)}...`);
                    return true;
                } else {
                    console.log('Clerk SDK: æ‰¾åˆ°è„šæœ¬æ ‡ç­¾ä½†Keyæ— æ•ˆ');
                }
            }
            
            window.clerkAvailable = false;
            console.log('Clerk SDK: æœªæ£€æµ‹åˆ°æœ‰æ•ˆé…ç½®');
            return false;
        }
        
        // æ‰§è¡Œæ£€æµ‹
        detectClerkConfiguration();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
        }

        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            z-index: 998;
            height: calc(75vh - 60px);
            max-height: calc(100vh - 120px);
            display: none;
            overflow-y: auto;
        }

        .control-panel.show {
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .settings-button {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }

        .settings-button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex-shrink: 0;
        }

        .close-btn {
            cursor: pointer;
            font-size: 20px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .close-btn:hover {
            opacity: 1;
        }

        .panel-header h2 {
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .control-panel.collapsed .toggle-btn {
            transform: rotate(180deg);
        }

        .panel-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        /* å‚æ•°é…ç½®åŒºåŸŸ */
        .config-section {
            display: grid;
            grid-template-columns: 1fr 2fr 2fr 2fr;
            gap: 20px;
            height: 100%;
        }

        .config-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: calc(75vh - 120px);
            /* å›ºå®šæœ€å¤§é«˜åº¦ */
        }

        .config-group h3 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .config-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .config-row:last-child {
            margin-bottom: 0;
        }

        .config-row label {
            flex: 0 0 120px;
            font-size: 13px;
            color: #6c757d;
            font-weight: 500;
        }

        .config-row input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        .config-row input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .config-row input[type="number"] {
            width: 80px;
        }

        .config-row .unit {
            margin-left: 8px;
            color: #6c757d;
            font-size: 12px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        button.primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        button.secondary {
            background: #6c757d;
            color: white;
        }

        button.success {
            background: #28a745;
            color: white;
        }

        button.danger {
            background: #dc3545;
            color: white;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* æ—¥å¿—åŒºåŸŸ */
        .log-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-container h3 {
            color: #0f0;
            margin-bottom: 10px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }

        #log {
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ - ä¸‰æ å¸ƒå±€ */
        .main-content {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .events-container {
            display: grid;
            grid-template-columns: 2fr 2fr 3.6fr 2fr;
            gap: 15px;
            height: calc(100vh - 40px);
            min-height: 400px;
        }

        .events-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .events-section h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .events-content {
            flex: 1;
            overflow-y: auto;
        }

        /* å¡ç‰‡æ ·å¼ */
        .event-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: all 0.2s;
            animation: slideIn 0.3s ease;
        }

        .event-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            transform: translateY(-1px);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .event-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .card-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .card-timestamp {
            color: #6c757d;
            margin-bottom: 2px;
            font-size: 10px;
        }

        .card-final-timestamp {
            color: #28a745;
            margin-bottom: 6px;
            font-size: 10px;
            font-weight: 500;
        }

        .event-content {
            font-size: 13px;
            color: #6c757d;
            line-height: 1.5;
        }

        /* VADäº‹ä»¶å¡ç‰‡ */
        .vad-event-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: 1px solid #c3cfe2;
        }

        /* ASRç»“æœå¡ç‰‡ */
        .asr-result-card {
            background: linear-gradient(135deg, #e8f5e8 0%, #c3e6c3 100%);
            border: 1px solid #c3e6c3;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: all 0.3s ease;
        }

        /* Prefetch ASRç»“æœå¡ç‰‡ - é»„è‰² */
        .asr-result-card.prefetch {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe082 100%);
            border: 1px solid #ffe082;
        }

        /* ç¼“å­˜ASRç»“æœå¡ç‰‡ - ç»¿è‰²ï¼ˆè¦†ç›–prefetchï¼‰ */
        .asr-result-card.cached {
            background: linear-gradient(135deg, #e8f5e8 0%, #a5d6a7 100%);
            border: 1px solid #4caf50;
        }

        /* é‡æ–°å¤„ç†çš„ASRç»“æœå¡ç‰‡ - ç´«è‰² */
        .asr-result-card.reprocessed {
            background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%);
            border: 1px solid #9c27b0;
        }

        /* è¢«ä¸¢å¼ƒçš„ASRç»“æœå¡ç‰‡ - ç°è‰² + åˆ’çº¿ */
        .asr-result-card.dropped {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            border: 1px solid #bdbdbd;
            opacity: 0.7;
            max-height: 80px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .asr-result-card.dropped .asr-text {
            text-decoration: line-through;
            color: #757575;
        }

        .asr-result-card.dropped .card-title {
            color: #757575;
            font-size: 11px;
        }

        .asr-result-card.dropped .card-timestamp {
            color: #9e9e9e;
            font-size: 10px;
        }

        .asr-result-card.dropped .asr-text {
            font-size: 12px;
        }

        .asr-result-card:hover:not(.dropped) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .asr-result-card.dropped:hover {
            transform: none;
            box-shadow: none;
        }

        .asr-result-card.selected {
            background: linear-gradient(135deg, #c3e6c3 0%, #81c784 100%);
            border: 2px solid #4caf50;
            animation: selectPulse 0.3s ease;
        }

        .asr-result-card.selected::before {
            content: 'âœ“';
            position: absolute;
            top: 8px;
            right: 8px;
            background: #4caf50;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            animation: checkIn 0.3s ease;
        }

        @keyframes selectPulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes checkIn {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }

            50% {
                transform: scale(1.2) rotate(10deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .asr-text {
            font-size: 14px;
            color: #2e7d32;
            font-weight: 500;
            margin: 8px 0;
            padding: 4px 8px;
            border-radius: 4px;
            min-height: 20px;
            word-wrap: break-word;
        }

        .asr-meta {
            font-size: 11px;
            color: #666;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* LLMå“åº”å¡ç‰‡ */
        .llm-response-card {
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);
            border: 1px solid #ffcc80;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .llm-response-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
        }

        .llm-response-card .llm-summary {
            display: block;
        }

        .llm-response-card .llm-details {
            display: none;
            margin-top: 15px;
            animation: fadeIn 0.3s ease;
        }

        .llm-response-card.expanded .llm-summary {
            display: none;
        }

        .llm-response-card.expanded .llm-details {
            display: block;
        }

        .llm-response-card.expanded {
            background: linear-gradient(135deg, #ffcc80 0%, #ffa726 100%);
            border: 2px solid #ff9800;
        }

        .llm-response-card.expanded::before {
            content: 'ğŸ“–';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 16px;
            animation: fadeIn 0.3s ease;
        }

        .llm-toggle-indicator {
            position: absolute;
            bottom: 8px;
            right: 8px;
            font-size: 12px;
            color: #ff9800;
            font-weight: bold;
        }

        .llm-response-card:not(.expanded) .llm-toggle-indicator::after {
            content: 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â–¼';
        }

        .llm-response-card.expanded .llm-toggle-indicator::after {
            content: 'ç‚¹å‡»æ”¶èµ· â–²';
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ç©ºçŠ¶æ€æç¤º */
        .empty-state {
            text-align: center;
            color: #adb5bd;
            padding: 40px 20px;
            font-size: 14px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.3;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-indicator.connected {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-indicator.disconnected {
            background: #dc3545;
        }

        .status-indicator.connecting {
            background: #ffc107;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1400px) {
            .events-container {
                grid-template-columns: 1fr 1fr;
                height: auto;
            }

            .events-section {
                height: 400px;
            }
        }

        @media (max-width: 1000px) {
            .events-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .events-section {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .config-section {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-wrap: wrap;
            }

            button {
                flex: 1;
                min-width: 120px;
            }
        }

        /* ASR Promptç›¸å…³æ ·å¼ */
        .card-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .asr-prompt-toggle {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #666;
            min-width: 32px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .asr-prompt-toggle:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-1px);
        }

        .asr-prompt-section {
            margin-top: 10px;
            padding: 10px;
            background: rgba(76, 175, 80, 0.05);
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 6px;
            animation: slideDown 0.3s ease;
        }

        .asr-prompt-header {
            font-size: 12px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .asr-prompt-content {
            font-family: 'Courier New', Monaco, monospace;
            font-size: 11px;
            background: rgba(0, 0, 0, 0.05);
            padding: 8px 10px;
            border-radius: 4px;
            color: #333;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
                max-height: 0;
            }

            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 300px;
            }
        }

        /* LLMç¼–è¾‘ç›¸å…³æ ·å¼ */
        .llm-processed-output:focus,
        .llm-processed-output-summary:focus {
            outline: 2px solid #4caf50;
            background: rgba(76, 175, 80, 0.1) !important;
            border-color: #4caf50 !important;
        }

        .llm-processed-output:hover,
        .llm-processed-output-summary:hover {
            border-color: #4caf50;
            cursor: text;
        }
    </style>
</head>

<body>
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel" id="controlPanel">
        <div class="panel-header">
            <h2>âš™ï¸ è®¾ç½®é¢æ¿</h2>
            <span class="close-btn" onclick="togglePanel()">âœ•</span>
        </div>

        <div class="panel-content">
            <!-- å‚æ•°é…ç½® -->
            <div class="config-section">
                <!-- ç¬¬ä¸€åˆ—ï¼šé€šç”¨é…ç½® -->
                <div class="config-group">
                    <h3 style="margin-bottom: 15px; flex-shrink: 0;">âš™ï¸ é€šç”¨è®¾ç½®</h3>
                    <div style="overflow-y: auto; flex: 1; max-height: calc(75vh - 180px);">
                        <!-- é™éŸ³è¶…æ—¶è®¾ç½® -->
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #495057; font-size: 13px;">â±ï¸ å½•éŸ³æ§åˆ¶</strong>
                            <div class="config-row" style="margin-top: 8px;">
                                <label style="min-width: 80px; font-size: 12px;">é™éŸ³è¶…æ—¶:</label>
                                <input type="number" id="silenceTimeoutSec" value="10" min="1" max="300" step="1"
                                    style="width: 60px; font-size: 12px;">
                                <span class="unit" style="font-size: 11px;">ç§’</span>
                            </div>
                        </div>

                        <!-- Clerk èº«ä»½è®¤è¯ -->
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #495057; font-size: 13px;">ğŸ” èº«ä»½è®¤è¯</strong>

                            <!-- Clerk ä¸å¯ç”¨çŠ¶æ€ -->
                            <div id="clerk-unavailable"
                                style="display: none; padding: 8px; background: #fff3e0; border: 1px solid #ffcc80; border-radius: 4px;">
                                <div style="font-size: 12px; color: #e65100; margin-bottom: 6px;">âš ï¸ Clerk è®¤è¯ä¸å¯ç”¨</div>
                                <div style="font-size: 11px; color: #bf360c; line-height: 1.3;">
                                    è¯·åœ¨ index.html ä¸­é…ç½®æœ‰æ•ˆçš„ Clerk Publishable Key<br>
                                    <strong>ä¸´æ—¶æ–¹æ¡ˆ:</strong> å¯æ‰‹åŠ¨è¾“å…¥ç¥¨æ®è¿›è¡Œæµ‹è¯•
                                </div>
                            </div>

                            <!-- åŠ è½½çŠ¶æ€ -->
                            <div id="clerk-loading" style="padding: 10px; text-align: center; color: #666;">
                                <div style="font-size: 12px; margin-bottom: 5px;">æ­£åœ¨åŠ è½½ Clerk SDK...</div>
                                <div
                                    style="width: 20px; height: 20px; border: 2px solid #ddd; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;">
                                </div>
                            </div>

                            <!-- æœªç™»å½•çŠ¶æ€ -->
                            <div id="clerk-signed-out" style="display: none; padding: 8px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 8px;">è¯·å…ˆç™»å½•æ‚¨çš„è´¦æˆ·</div>
                                <div style="display: flex; gap: 4px;">
                                    <button class="primary" onclick="signInClerk()"
                                        style="flex: 1; padding: 6px; font-size: 12px;">
                                        ğŸ” ç™»å½•
                                    </button>
                                    <button class="secondary" onclick="signUpClerk()"
                                        style="flex: 1; padding: 6px; font-size: 12px;">
                                        ğŸ“ æ³¨å†Œ
                                    </button>
                                </div>
                            </div>

                            <!-- å·²ç™»å½•çŠ¶æ€ -->
                            <div id="clerk-signed-in" style="display: none;">
                                <div id="clerk-user-info"
                                    style="font-size: 11px; color: #555; margin-bottom: 8px; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                </div>
                                <div style="display: flex; gap: 4px; margin-bottom: 6px;">
                                    <button class="primary" id="btn-get-jwt-token" onclick="getJWTToken()"
                                        style="flex: 1; padding: 6px; font-size: 12px;">
                                        ğŸ« è·å–Token
                                    </button>
                                    <button class="secondary" onclick="signOutClerk()"
                                        style="padding: 6px 8px; font-size: 12px;">
                                        ğŸšª é€€å‡º
                                    </button>
                                </div>
                                <div id="clerk-auth-status"
                                    style="font-size: 11px; padding: 4px; border-radius: 3px; display: none;"></div>
                            </div>
                        </div>

                        <!-- WebSocketè®¾ç½® -->
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #495057; font-size: 13px;">ğŸŒ WebSocket</strong>
                            <div class="config-row" style="margin-top: 8px;">
                                <label style="min-width: 80px;">WSåœ°å€:</label>
                                <input type="text" id="wsUrl" value="/api/ws" style="flex: 1; font-size: 12px;">
                            </div>
                            <div class="config-row" style="margin-top: 8px;">
                                <label style="min-width: 80px;">WS Ticket:</label>
                                <input type="text" id="wsTicket" placeholder="è¾“å…¥WebSocketç¥¨æ®"
                                    style="flex: 1; font-size: 12px;">
                            </div>
                            <div class="config-row" style="margin-top: 8px;">
                                <button class="secondary" onclick="getWebSocketTicket()"
                                    style="width: 48%; padding: 6px; font-size: 12px; margin-right: 4%;">
                                    ğŸ« è·å–ç¥¨æ®
                                </button>
                                <button class="secondary" onclick="testWebSocketConnection()"
                                    style="width: 48%; padding: 6px; font-size: 12px;">
                                    ğŸ”— æµ‹è¯•è¿æ¥
                                </button>
                            </div>
                        </div>

                        <!-- LLMè®¾ç½® -->
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #495057; font-size: 13px;">ğŸ¤– LLMè®¾ç½®</strong>
                            <div class="config-row" style="margin-top: 8px;">
                                <label style="min-width: 80px;">LLMåœ°å€:</label>
                                <input type="text" id="llmUrl" value="https://api.frapp.ai/llm"
                                    style="flex: 1; font-size: 12px;">
                            </div>
                            <div class="config-row" style="margin-top: 8px;">
                                <label style="min-width: 80px;">æ¨¡å‹:</label>
                                <select id="llmModel"
                                    style="flex: 1; padding: 6px; border: 1px solid #ced4da; border-radius: 3px; font-size: 12px;">
                                    <option value="gemini2.0">Gemini 2.0</option>
                                    <option value="gemini2.5" selected>Gemini 2.5</option>
                                    <option value="orouter_gemini2.5">ORouter Gemini 2.5</option>
                                    <option value="orouter_gemini2.0">ORouter Gemini 2.0</option>
                                    <option value="orouter_qwen3">ORouter Qwen3</option>
                                </select>
                            </div>
                        </div>

                        <hr style="margin: 10px 0; border: none; border-top: 1px solid #dee2e6;">

                        <!-- VADè®¾ç½® -->
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #495057; font-size: 13px;">ğŸ™ï¸ VADå‚æ•°</strong>
                            <div class="config-row" style="margin-top: 8px;">
                                <label style="min-width: 80px; font-size: 12px;">æ£€æµ‹é˜ˆå€¼:</label>
                                <input type="number" id="threshold" value="0.1" min="0" max="1" step="0.1"
                                    style="width: 60px; font-size: 12px;">
                                <span class="unit" style="font-size: 11px;">(0-1)</span>
                            </div>
                            <div class="config-row" style="margin-top: 6px;">
                                <label style="min-width: 80px; font-size: 12px;">è¯­éŸ³å‰ç¼€:</label>
                                <input type="number" id="prefixMs" value="64" min="0" step="16"
                                    style="width: 60px; font-size: 12px;">
                                <span class="unit" style="font-size: 11px;">ms</span>
                            </div>
                            <div class="config-row" style="margin-top: 6px;">
                                <label style="min-width: 80px; font-size: 12px;">é™éŸ³æŒç»­:</label>
                                <input type="number" id="silenceMs" value="480" min="0" step="16"
                                    style="width: 60px; font-size: 12px;">
                                <span class="unit" style="font-size: 11px;">ms</span>
                            </div>
                            <div class="config-row" style="margin-top: 6px;">
                                <label style="min-width: 80px; font-size: 12px;">ASRè§¦å‘:</label>
                                <input type="number" id="asrTriggerMs" value="192" min="0" step="16"
                                    style="width: 60px; font-size: 12px;">
                                <span class="unit" style="font-size: 11px;">ms</span>
                            </div>
                            <div class="config-row" style="margin-top: 6px;">
                                <label style="min-width: 80px; font-size: 12px;">è·³æ­¥é—´éš”:</label>
                                <input type="number" id="hopMs" value="16" min="8" step="8"
                                    style="width: 60px; font-size: 12px;">
                                <span class="unit" style="font-size: 11px;">ms</span>
                            </div>
                            <div class="config-row" style="margin-top: 6px;">
                                <label style="min-width: 80px; font-size: 12px;">é¢„å–æ¨¡å¼:</label>
                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px;">
                                    <input type="checkbox" id="enablePrefetch" checked style="margin-right: 6px;">
                                    å¯ç”¨Prefetch ASR
                                </label>
                            </div>
                            <div class="config-row" style="margin-top: 10px;">
                                <button class="primary" onclick="applyVADConfig()"
                                    style="width: 100%; padding: 6px; font-size: 12px;">
                                    âœ… åº”ç”¨VADé…ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¬¬äºŒåˆ—ï¼šLLM Prompt -->
                <div class="config-group">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">ğŸ¤– LLM Prompt</h3>
                        <button id="autoLLMToggle" onclick="toggleAutoLLM()"
                            style="padding: 4px 8px; font-size: 11px; border-radius: 12px; border: 1px solid #ddd; background: #f8f9fa; color: #666; cursor: pointer; transition: all 0.3s;">
                            <span id="autoLLMStatus">è‡ªåŠ¨å›å¤: å…³</span>
                        </button>
                    </div>
                    <div style="display: flex; flex-direction: column; flex: 1; gap: 15px;">
                        <div style="flex: 1; min-height: 200px;">
                            <textarea id="llmPrompt"
                                style="width: 100%; height: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; resize: none;"
                                placeholder="åœ¨æ­¤è¾“å…¥LLMç³»ç»Ÿæç¤ºè¯...\n\nç¤ºä¾‹ï¼š\nä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŠ©æ‰‹ï¼Œè¯·å¸®åŠ©ç”¨æˆ·æ•´ç†å’Œæ€»ç»“å¯¹è¯å†…å®¹ã€‚"></textarea>
                        </div>
                        <button class="secondary" onclick="clearAll()" style="padding: 10px; font-size: 14px;">
                            ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è®°å½•
                        </button>
                    </div>
                </div>

                <!-- ç¬¬ä¸‰åˆ—ï¼šASR Prompt & Input/Output Rule -->
                <div class="config-group">
                    <h3 style="margin-bottom: 15px; flex-shrink: 0;">ğŸ¯ ASR & LLM Rules</h3>
                    <div style="display: flex; flex-direction: column; flex: 1; gap: 10px; height: 100%;">
                        <!-- ASR Prompt åŒºåŸŸ -->
                        <div style="flex: 0 0 auto;">
                            <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #495057;">ğŸ™ï¸ ASR Prompt</h4>
                            <textarea id="asrPrompt"
                                style="width: 100%; height: 80px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px; resize: none;"
                                placeholder="ASR Promptæ¨¡æ¿ï¼ˆåœ¨cache_asr_triggerå’ŒVAD endæ—¶å‘é€ï¼‰...\n\næ”¯æŒå˜é‡ï¼š$0_asr, $1_asr, $0_llm, $1_llm, $user_interface\n\nç¤ºä¾‹ï¼šè¯·è¯†åˆ«ä»¥ä¸‹è¯­éŸ³ï¼Œä¸Šä¸‹æ–‡ï¼š$0_asr"></textarea>
                        </div>

                        <!-- Input Rule åŒºåŸŸ -->
                        <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                            <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #495057;">ğŸ“ Input Rule</h4>
                            <textarea id="inputRule"
                                style="width: 100%; height: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px; resize: none;"
                                placeholder="LLM Input Ruleæ¨¡æ¿...\n\næ”¯æŒå˜é‡ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰ï¼š\n$0_asr, $0_modasr - æœ€æ–°ä¸€å¥è¯çš„åŸå§‹/ä¿®æ”¹åæ–‡æœ¬\n$1_asr, $1_modasr - å€’æ•°ç¬¬äºŒå¥è¯çš„åŸå§‹/ä¿®æ”¹åæ–‡æœ¬\n$*_asr, $*_modasr - å…¨æ–‡æ‹¼æ¥\n$0_llm, $1_llm - LLMè¾“å‡ºï¼ˆç»è¿‡Output Ruleå¤„ç†ï¼‰\n$*_llm - æ‰€æœ‰LLMè¾“å‡ºæ‹¼æ¥\n$user_interface - ç”¨æˆ·ç•Œé¢å†…å®¹\n\nç¤ºä¾‹ï¼š\n{&quot;text&quot;: &quot;$1_asr\n$0_asr&quot;}"></textarea>
                        </div>

                        <!-- Output Rule åŒºåŸŸ -->
                        <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                            <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #495057;">ğŸ“¤ Output Rule</h4>
                            <textarea id="outputRule"
                                style="width: 100%; height: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px; resize: none;"
                                placeholder="Output Ruleæ¨¡æ¿...\n\nä»LLMè¾“å‡ºæå–å†…å®¹ï¼Œæ”¯æŒå¤šç§JSONæ ¼å¼ï¼š\nâ€¢ ```json{...}```\nâ€¢ ```{...}```\nâ€¢ ç›´æ¥çš„JSONå¯¹è±¡ {...}\n\nç„¶åä½¿ç”¨å˜é‡æå–ï¼Œå¦‚ï¼š$a, $b\næ”¯æŒæ•°ç»„è®¿é—®ï¼š$a[0], $b[1]\n\nç¤ºä¾‹ï¼š\n$best_hyp"></textarea>
                        </div>

                        <div
                            style="font-size: 11px; color: #666; background: #f8f9fa; padding: 6px; border-radius: 4px; flex-shrink: 0;">
                            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                            â€¢ ASR: åœ¨VAD trigger/endæ—¶å‘é€ç»™ASR API<br>
                            â€¢ Input: $*_asr(å…¨æ–‡), $0_asr(æœ€æ–°), $*_llm(å…¨éƒ¨LLMè¾“å‡º), $0_llm(æœ€æ–°LLMè¾“å‡º),
                            $user_interface(ç”¨æˆ·ç•Œé¢å†…å®¹)<br>
                            â€¢ Output: ä»LLM JSONå“åº”ä¸­æå–ï¼Œæ”¯æŒ$key, $key[index]æ ¼å¼
                        </div>
                    </div>
                </div>

                <!-- ç¬¬å››åˆ—ï¼šå®æ—¶æ—¥å¿— -->
                <div class="config-group" style="background: #1e1e1e;">
                    <h3
                        style="color: #0f0; margin-bottom: 15px; font-family: 'Courier New', monospace; font-size: 14px; flex-shrink: 0;">
                        ğŸ“‹ å®æ—¶æ—¥å¿—</h3>
                    <div id="settingsLog"
                        style="flex: 1; overflow-y: auto; color: #0f0; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; padding: 10px; background: #000; border-radius: 4px; max-height: calc(75vh - 180px); min-height: 300px;">
                        <!-- æ—¥å¿—å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶æ  -->
    <div
        style="position: fixed; bottom: 20px; left: 20px; z-index: 999; display: flex; gap: 10px; align-items: center;">
        <!-- å½•éŸ³æŒ‰é’® -->
        <button id="recordBtn" class="record-button" onclick="toggleRecording()">
            <span class="record-icon">ğŸ¤</span>
            <span class="record-text">å¼€å§‹å½•éŸ³</span>
        </button>

        <!-- æ¸…ç©ºå¡ç‰‡æŒ‰é’® -->
        <button class="clear-cards-button" onclick="clearCards()">
            <span style="font-size: 18px;">ğŸ—‘ï¸</span>
        </button>

        <!-- è®¾ç½®æŒ‰é’® -->
        <button class="settings-button" onclick="togglePanel()">
            <span style="font-size: 18px;">âš™ï¸</span>
        </button>
    </div>

    <style>
        .record-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 24px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            height: 44px;
        }

        .record-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .record-button.recording {
            background: linear-gradient(135deg, #f93b1d 0%, #ea4c46 100%);
            animation: pulse 1.5s infinite;
        }

        .record-button.recording .record-icon {
            animation: blink 1s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 2px 10px rgba(249, 59, 29, 0.4);
            }

            50% {
                box-shadow: 0 2px 15px rgba(249, 59, 29, 0.6);
            }

            100% {
                box-shadow: 0 2px 10px rgba(249, 59, 29, 0.4);
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .clear-cards-button {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(220, 53, 69, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }

        .clear-cards-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }
    </style>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <div class="events-container">
            <!-- VADäº‹ä»¶ -->
            <div class="events-section">
                <h3>ğŸ“Š å®æ—¶VADäº‹ä»¶<button onclick="clearVADCards()"
                        style="background: none; border: 1px solid #ddd; border-radius: 4px; padding: 2px 6px; font-size: 11px; margin-left: 10px; cursor: pointer; color: #666;">æ¸…ç©º</button>
                </h3>
                <div class="events-content" id="vadEvents">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ¤</div>
                        <div>ç­‰å¾…VADäº‹ä»¶...</div>
                    </div>
                </div>
            </div>

            <!-- ASRç»“æœ -->
            <div class="events-section">
                <h3>ğŸ¯ ASRè¯†åˆ«ç»“æœ<button onclick="clearASRCards()"
                        style="background: none; border: 1px solid #ddd; border-radius: 4px; padding: 2px 6px; font-size: 11px; margin-left: 10px; cursor: pointer; color: #666;">æ¸…ç©º</button>
                </h3>
                <div class="events-content" id="asrResults">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’¬</div>
                        <div>ç­‰å¾…è¯­éŸ³è¯†åˆ«...</div>
                    </div>
                </div>
                <div id="asrActions" style="display: none; padding: 10px; border-top: 1px solid #e9ecef;">
                    <button class="primary" onclick="submitToLLM()"
                        style="width: 100%; padding: 10px; font-size: 14px;">
                        ğŸ¤– æäº¤ç»™LLM (<span id="selectedCount">0</span>ä¸ªé€‰ä¸­)
                    </button>
                </div>
            </div>

            <!-- LLMå“åº” -->
            <div class="events-section">
                <h3>ğŸ¤– LLMå“åº”<button onclick="clearLLMCards()"
                        style="background: none; border: 1px solid #ddd; border-radius: 4px; padding: 2px 6px; font-size: 11px; margin-left: 10px; cursor: pointer; color: #666;">æ¸…ç©º</button>
                </h3>
                <div class="events-content" id="llmResponses">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ¤–</div>
                        <div>LLMåŠŸèƒ½å¾…å¼€å‘...</div>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·ç•Œé¢ -->
            <div class="events-section">
                <h3>ğŸ‘¤ ç”¨æˆ·ç•Œé¢<button onclick="clearUserInterfaceCards()"
                        style="background: none; border: 1px solid #ddd; border-radius: 4px; padding: 2px 6px; font-size: 11px; margin-left: 10px; cursor: pointer; color: #666;">æ¸…ç©º</button>
                </h3>
                <div class="events-content">
                    <textarea id="userInterface" readonly
                        style="width: 100%; height: 100%; border: none; background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%); padding: 15px; font-size: 13px; color: #01579b; line-height: 1.5; font-family: inherit; resize: none; outline: none;"
                        placeholder="ç”¨æˆ·ç•Œé¢è¾“å‡ºå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="vad/stream_vad.js"></script>
    <script src="audio_client.js"></script>
    <script src="debug.js"></script>
    

    <script>
        let isConnected = false;
        let isRecording = false;
        let vadInitialized = false;
        let selectedASRCards = new Set();
        let asrTextMap = new Map(); // åŸå§‹ASRæ–‡æœ¬
        let asrPromptMap = new Map(); // å­˜å‚¨æ¯ä¸ªå¡ç‰‡å¯¹åº”çš„ASR prompt (cardId -> prompt)
        let prefetchResults = new Map(); // å­˜å‚¨prefetchç»“æœ (cardId -> result)
        let llmResponsesData = []; // å­˜å‚¨æ‰€æœ‰LLMå“åº”
        let userInterfaceContent = ''; // ç”¨æˆ·ç•Œé¢å†…å®¹
        let silenceTimer = null;
        let lastVADEndTime = null;
        let autoLLMEnabled = false;
        let llmResponseCounter = 0;
        let lastGeneratedASRPrompt = ''; // å­˜å‚¨æœ€åä¸€æ¬¡ç”Ÿæˆçš„ASR prompt

        // å¥å­åºå·ç®¡ç†
        let nextSentenceNumber = 1; // ä¸‹ä¸€ä¸ªå¯ç”¨çš„å¥å­åºå·
        let cardIdCounter = 0; // å¡ç‰‡IDè®¡æ•°å™¨

        // Clerk è®¤è¯ç›¸å…³å˜é‡
        let currentUser = null;
        let authToken = null;
        let isClerkInitialized = false;

        // localStorageç›¸å…³åŠŸèƒ½ - è®¾ç½®æŒä¹…åŒ–
        function saveSettings() {
            const settings = {
                // å½•éŸ³æ§åˆ¶é…ç½®
                silenceTimeoutSec: document.getElementById('silenceTimeoutSec').value,

                // WebSocketå’ŒLLMé…ç½®
                wsUrl: document.getElementById('wsUrl').value,
                wsTicket: document.getElementById('wsTicket').value,
                llmUrl: document.getElementById('llmUrl').value,
                llmModel: document.getElementById('llmModel').value,
                llmPrompt: document.getElementById('llmPrompt').value,
                asrPrompt: document.getElementById('asrPrompt').value,
                inputRule: document.getElementById('inputRule').value,
                outputRule: document.getElementById('outputRule').value,

                // VADé…ç½®
                threshold: document.getElementById('threshold').value,
                prefixMs: document.getElementById('prefixMs').value,
                silenceMs: document.getElementById('silenceMs').value,
                asrTriggerMs: document.getElementById('asrTriggerMs').value,
                hopMs: document.getElementById('hopMs').value,
                enablePrefetch: document.getElementById('enablePrefetch').checked,

                // è‡ªåŠ¨LLMçŠ¶æ€
                autoLLMEnabled: autoLLMEnabled
            };

            localStorage.setItem('app-settings', JSON.stringify(settings));
            log('è®¾ç½®å·²ä¿å­˜', 'info');
        }

        function loadSettings() {
            const saved = localStorage.getItem('app-settings');
            if (!saved) return;

            try {
                const settings = JSON.parse(saved);

                // æ¢å¤å½•éŸ³æ§åˆ¶é…ç½®
                if (settings.silenceTimeoutSec) document.getElementById('silenceTimeoutSec').value = settings.silenceTimeoutSec;

                // æ¢å¤WebSocketå’ŒLLMé…ç½®
                if (settings.wsUrl) document.getElementById('wsUrl').value = settings.wsUrl;
                if (settings.wsTicket) document.getElementById('wsTicket').value = settings.wsTicket;
                if (settings.llmUrl) document.getElementById('llmUrl').value = settings.llmUrl;
                if (settings.llmModel) document.getElementById('llmModel').value = settings.llmModel;
                if (settings.llmPrompt) document.getElementById('llmPrompt').value = settings.llmPrompt;
                if (settings.asrPrompt) document.getElementById('asrPrompt').value = settings.asrPrompt;
                if (settings.inputRule) document.getElementById('inputRule').value = settings.inputRule;
                if (settings.outputRule) document.getElementById('outputRule').value = settings.outputRule;

                // æ¢å¤VADé…ç½®
                if (settings.threshold) document.getElementById('threshold').value = settings.threshold;
                if (settings.prefixMs) document.getElementById('prefixMs').value = settings.prefixMs;
                if (settings.silenceMs) document.getElementById('silenceMs').value = settings.silenceMs;
                if (settings.asrTriggerMs) document.getElementById('asrTriggerMs').value = settings.asrTriggerMs;
                if (settings.hopMs) document.getElementById('hopMs').value = settings.hopMs;
                if (settings.enablePrefetch !== undefined) document.getElementById('enablePrefetch').checked = settings.enablePrefetch;

                // æ¢å¤è‡ªåŠ¨LLMçŠ¶æ€
                if (settings.autoLLMEnabled) {
                    autoLLMEnabled = true;
                    const toggleBtn = document.getElementById('autoLLMToggle');
                    const statusSpan = document.getElementById('autoLLMStatus');
                    toggleBtn.style.background = '#4caf50';
                    toggleBtn.style.color = 'white';
                    toggleBtn.style.borderColor = '#4caf50';
                    statusSpan.textContent = 'è‡ªåŠ¨å›å¤: å¼€';
                }

                log('è®¾ç½®å·²æ¢å¤', 'success');
            } catch (error) {
                log('åŠ è½½è®¾ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è®¾ç½®ç›‘å¬å™¨
        function setupSettingsListeners() {
            // å½•éŸ³æ§åˆ¶é…ç½®å˜åŒ–ç›‘å¬
            document.getElementById('silenceTimeoutSec').addEventListener('input', saveSettings);

            // WebSocketå’ŒLLMé…ç½®å˜åŒ–ç›‘å¬
            document.getElementById('wsUrl').addEventListener('input', saveSettings);
            document.getElementById('wsTicket').addEventListener('input', saveSettings);
            document.getElementById('llmUrl').addEventListener('input', saveSettings);
            document.getElementById('llmModel').addEventListener('change', saveSettings);
            document.getElementById('llmPrompt').addEventListener('input', saveSettings);
            document.getElementById('asrPrompt').addEventListener('input', saveSettings);
            document.getElementById('inputRule').addEventListener('input', saveSettings);
            document.getElementById('outputRule').addEventListener('input', saveSettings);

            // VADé…ç½®å˜åŒ–ç›‘å¬
            document.getElementById('threshold').addEventListener('input', saveSettings);
            document.getElementById('prefixMs').addEventListener('input', saveSettings);
            document.getElementById('silenceMs').addEventListener('input', saveSettings);
            document.getElementById('asrTriggerMs').addEventListener('input', saveSettings);
            document.getElementById('hopMs').addEventListener('input', saveSettings);
            document.getElementById('enablePrefetch').addEventListener('change', saveSettings);
        }

        // =============================================================================
        // CLERK è®¤è¯ç›¸å…³åŠŸèƒ½
        // =============================================================================

        // åˆå§‹åŒ– Clerk SDK
        async function initializeClerk() {
            // æ£€æŸ¥ Clerk æ˜¯å¦å¯ç”¨
            if (window.clerkAvailable === false) {
                log('Clerk SDK ä¸å¯ç”¨: æœªé…ç½®æœ‰æ•ˆçš„ Publishable Key', 'warning');
                document.getElementById('clerk-loading').style.display = 'none';
                document.getElementById('clerk-unavailable').style.display = 'block';
                return;
            }

            try {
                const detectedKey = window.detectedClerkKey || 'unknown';
                log(`æ­£åœ¨åˆå§‹åŒ– Clerk SDK... (Key: ${detectedKey.substring(0, 20)}...)`, 'info');

                // ç­‰å¾… Clerk SDK åŠ è½½
                let attempts = 0;
                const maxAttempts = 100; // 10ç§’è¶…æ—¶

                await new Promise((resolve, reject) => {
                    const checkClerk = () => {
                        attempts++;
                        if (window.Clerk) {
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            reject(new Error('Clerk SDK è„šæœ¬åŠ è½½è¶…æ—¶ (10ç§’)'));
                        } else {
                            setTimeout(checkClerk, 100);
                        }
                    };
                    checkClerk();
                });

                log('Clerk SDK è„šæœ¬å·²åŠ è½½ï¼Œæ­£åœ¨åˆå§‹åŒ–...', 'info');
                await window.Clerk.load();
                isClerkInitialized = true;
                log(`Clerk SDK åˆå§‹åŒ–æˆåŠŸ! Key: ${detectedKey.substring(0, 20)}...`, 'success');

                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('clerk-loading').style.display = 'none';

                // æ£€æŸ¥è®¤è¯çŠ¶æ€
                checkAuthState();

                // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
                window.Clerk.addListener('user', () => checkAuthState());
                window.Clerk.addListener('session', () => checkAuthState());

            } catch (error) {
                log(`Clerk SDK åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                
                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„æç¤º
                const unavailableDiv = document.getElementById('clerk-unavailable');
                const loadingDiv = document.getElementById('clerk-loading');
                
                loadingDiv.style.display = 'none';
                
                // æ›´æ–°é”™è¯¯æ¶ˆæ¯å†…å®¹
                const errorContent = unavailableDiv.querySelector('div:last-child');
                if (error.message.includes('è¶…æ—¶')) {
                    errorContent.innerHTML = `
                        æ£€æµ‹åˆ°Clerké…ç½®ä½†SDKåŠ è½½å¤±è´¥<br>
                        <strong>é”™è¯¯:</strong> ${error.message}<br>
                        <strong>å»ºè®®:</strong> æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–Keyæ˜¯å¦æœ‰æ•ˆ
                    `;
                } else if (error.message.includes('invalid')) {
                    errorContent.innerHTML = `
                        Clerk KeyéªŒè¯å¤±è´¥<br>
                        <strong>é”™è¯¯:</strong> ${error.message}<br>
                        <strong>å»ºè®®:</strong> è¯·æ£€æŸ¥Publishable Keyæ˜¯å¦æ­£ç¡®
                    `;
                } else {
                    errorContent.innerHTML = `
                        Clerk SDKåˆå§‹åŒ–å¤±è´¥<br>
                        <strong>é”™è¯¯:</strong> ${error.message}<br>
                        <strong>Key:</strong> ${window.detectedClerkKey?.substring(0, 30) || 'unknown'}...
                    `;
                }
                
                unavailableDiv.style.display = 'block';
            }
        }

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        function checkAuthState() {
            if (!isClerkInitialized) return;

            const user = window.Clerk.user;
            const session = window.Clerk.session;

            if (user && session) {
                // å·²ç™»å½•çŠ¶æ€
                currentUser = user;
                document.getElementById('clerk-signed-out').style.display = 'none';
                document.getElementById('clerk-signed-in').style.display = 'block';

                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                const userInfo = document.getElementById('clerk-user-info');
                userInfo.innerHTML =
                    `<strong>ç”¨æˆ·:</strong> ${user.fullName || user.primaryEmailAddress?.emailAddress || user.id}<br>` +
                    `<strong>ID:</strong> ${user.id}`;

                log(`ç”¨æˆ·å·²ç™»å½•: ${user.fullName || user.id}`, 'success');

            } else {
                // æœªç™»å½•çŠ¶æ€
                currentUser = null;
                authToken = null;
                document.getElementById('clerk-signed-out').style.display = 'block';
                document.getElementById('clerk-signed-in').style.display = 'none';

                // éšè—çŠ¶æ€æ¶ˆæ¯
                document.getElementById('clerk-auth-status').style.display = 'none';

                log('ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆå®Œæˆè®¤è¯', 'info');
            }
        }

        // Clerk ç™»å½•
        function signInClerk() {
            try {
                if (!isClerkInitialized) {
                    log('Clerk å°šæœªåˆå§‹åŒ–', 'error');
                    return;
                }
                window.Clerk.openSignIn();
            } catch (error) {
                log(`ç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // Clerk æ³¨å†Œ
        function signUpClerk() {
            try {
                if (!isClerkInitialized) {
                    log('Clerk å°šæœªåˆå§‹åŒ–', 'error');
                    return;
                }
                window.Clerk.openSignUp();
            } catch (error) {
                log(`æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // Clerk é€€å‡ºç™»å½•
        async function signOutClerk() {
            try {
                if (!isClerkInitialized) {
                    log('Clerk å°šæœªåˆå§‹åŒ–', 'error');
                    return;
                }
                await window.Clerk.signOut();
                log('å·²æˆåŠŸé€€å‡ºç™»å½•', 'info');
            } catch (error) {
                log(`é€€å‡ºç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å– JWT Token
        async function getJWTToken() {
            if (!window.Clerk.session) {
                log('æ²¡æœ‰æ´»åŠ¨ä¼šè¯ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                showClerkStatus('è¯·é‡æ–°ç™»å½•', 'error');
                return;
            }

            log('æ­£åœ¨è·å– Clerk JWT Token...', 'info');
            showClerkStatus('æ­£åœ¨è·å– Token...', 'info');

            try {
                // è·å–é»˜è®¤ token
                const token = await window.Clerk.session.getToken();

                if (!token) {
                    throw new Error('æ— æ³•è·å– JWT Token');
                }

                authToken = token;
                log(`JWT Token è·å–æˆåŠŸ: ${token.substring(0, 30)}...`, 'success');
                showClerkStatus('JWT Token è·å–æˆåŠŸï¼', 'success');

                // è‡ªåŠ¨å¤åˆ¶ token åˆ°å‰ªè´´æ¿
                try {
                    await navigator.clipboard.writeText(token);
                    log('Token å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'info');
                } catch (e) {
                    log('æ— æ³•è‡ªåŠ¨å¤åˆ¶ token', 'warning');
                }

            } catch (error) {
                log(`Token è·å–å¤±è´¥: ${error.message}`, 'error');
                showClerkStatus(`Token è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤º Clerk è®¤è¯çŠ¶æ€
        function showClerkStatus(message, type) {
            const statusEl = document.getElementById('clerk-auth-status');
            if (!statusEl) return;

            statusEl.style.display = 'block';
            statusEl.textContent = message;

            const colors = {
                info: '#4299e1',
                success: '#48bb78',
                error: '#f56565',
                warning: '#ed8936'
            };

            statusEl.style.backgroundColor = `${colors[type]}20`;
            statusEl.style.borderLeft = `3px solid ${colors[type]}`;
            statusEl.style.color = colors[type];

            // è‡ªåŠ¨éšè—æˆåŠŸå’Œä¿¡æ¯æ¶ˆæ¯
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        // è‡ªåŠ¨LLMåŠŸèƒ½
        function toggleAutoLLM() {
            autoLLMEnabled = !autoLLMEnabled;
            const toggleBtn = document.getElementById('autoLLMToggle');
            const statusSpan = document.getElementById('autoLLMStatus');

            if (autoLLMEnabled) {
                toggleBtn.style.background = '#4caf50';
                toggleBtn.style.color = 'white';
                toggleBtn.style.borderColor = '#4caf50';
                statusSpan.textContent = 'è‡ªåŠ¨å›å¤: å¼€';
                log('è‡ªåŠ¨LLMå›å¤å·²å¯ç”¨', 'success');
            } else {
                toggleBtn.style.background = '#f8f9fa';
                toggleBtn.style.color = '#666';
                toggleBtn.style.borderColor = '#ddd';
                statusSpan.textContent = 'è‡ªåŠ¨å›å¤: å…³';
                log('è‡ªåŠ¨LLMå›å¤å·²å…³é—­', 'info');
            }

            // ä¿å­˜è®¾ç½®
            saveSettings();
        }

        async function callLLMForASR(asrText) {
            if (!autoLLMEnabled) return;

            const systemPrompt = document.getElementById('llmPrompt').value || 'ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹ã€‚';
            const inputRule = document.getElementById('inputRule').value;

            // ä½¿ç”¨Input Ruleå¤„ç†ï¼ˆä¸ä¼ selectedCardsï¼Œè¡¨ç¤ºè‡ªåŠ¨æ¨¡å¼ï¼‰
            const userInput = processInputRule(inputRule, null);

            log(`è‡ªåŠ¨è°ƒç”¨LLM (åŸæ–‡: "${asrText}")`, 'info');
            log(`å¤„ç†åè¾“å…¥: "${userInput}"`, 'info');

            // å®é™…çš„LLM APIè°ƒç”¨
            const llmContainer = document.getElementById('llmResponses');
            if (llmContainer.querySelector('.empty-state')) {
                llmContainer.innerHTML = '';
            }

            // åˆ›å»ºåŠ è½½ä¸­çš„å“åº”å¡ç‰‡
            llmResponseCounter++;
            const loadingCardId = `llm-auto-loading-${llmResponseCounter}`;
            const loadingCard = document.createElement('div');
            loadingCard.className = 'event-card llm-response-card';
            loadingCard.id = loadingCardId;
            loadingCard.innerHTML = `
                <div class="event-header">${formatCurrentTime()} - è‡ªåŠ¨å›å¤å¤„ç†ä¸­...</div>
                <div class="llm-summary">
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4caf50; border-radius: 4px;">
                        <span class="spinner"></span>
                        <strong>ğŸ¤– æ­£åœ¨è‡ªåŠ¨ç”Ÿæˆå“åº”...</strong>
                    </div>
                </div>
            `;
            llmContainer.appendChild(loadingCard);
            llmContainer.scrollTop = llmContainer.scrollHeight;

            try {
                const llmUrl = document.getElementById('llmUrl').value || 'https://api.frapp.ai/llm';
                const llmModel = document.getElementById('llmModel').value || 'gemini2.5';

                const response = await fetch(llmUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        system_prompt: systemPrompt,
                        content: userInput,
                        model: llmModel,
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                log('è‡ªåŠ¨LLMå“åº”æˆåŠŸ', 'success');

                // ç§»é™¤åŠ è½½å¡ç‰‡
                loadingCard.remove();

                // åˆ›å»ºçœŸå®çš„å“åº”å¡ç‰‡
                createLLMResponseCard(result, userInput, systemPrompt, true);

            } catch (error) {
                log(`è‡ªåŠ¨LLMè¯·æ±‚å¤±è´¥: ${error.message}`, 'error');

                // ç§»é™¤åŠ è½½å¡ç‰‡
                loadingCard.remove();

                // åˆ›å»ºé”™è¯¯å“åº”å¡ç‰‡
                createLLMErrorCard(error, userInput, systemPrompt, true);
            }
        }

        // åˆ›å»ºLLMå“åº”å¡ç‰‡çš„é€šç”¨å‡½æ•°
        function createLLMResponseCard(result, userInput, systemPrompt, isAuto = false) {
            const llmContainer = document.getElementById('llmResponses');
            llmResponseCounter++;

            // å¤„ç†Output Rule
            const outputRule = document.getElementById('outputRule').value;
            const processedOutput = processOutputRule(result.response, outputRule);

            // å°†å¤„ç†åçš„è¾“å‡ºå­˜å‚¨åˆ°llmResponsesData
            const responseData = {
                id: `llm-${llmResponseCounter}`,
                response: result.response,
                processedOutput: processedOutput,
                modifiedProcessedOutput: processedOutput, // åˆå§‹æ—¶ä¸processedOutputç›¸åŒï¼Œå¯è¢«ç”¨æˆ·ç¼–è¾‘
                timestamp: formatCurrentTime(),
                isAuto: isAuto
            };
            llmResponsesData.push(responseData);

            // å°†å¤„ç†åçš„è¾“å‡ºæ·»åŠ åˆ°ç”¨æˆ·ç•Œé¢
            addToUserInterface(responseData.modifiedProcessedOutput, responseData.timestamp, isAuto);

            const responseCard = document.createElement('div');
            responseCard.className = 'event-card llm-response-card';
            const cardId = `llm-${llmResponseCounter}`;
            responseCard.id = cardId;

            const performance = result._performance;
            const modelInfo = `${performance?.model || 'Unknown'} (${performance?.provider || 'Unknown'})`;
            const duration = performance?.total_duration_ms ? `${performance.total_duration_ms}ms` : 'N/A';

            const responsePreview = processedOutput.length > 100 ?
                processedOutput.substring(0, 100) + '...' : processedOutput;

            const autoLabel = isAuto ? ' [è‡ªåŠ¨]' : '';

            responseCard.innerHTML = `
                <div class="event-header">${formatCurrentTime()} - ${modelInfo} (${duration})${autoLabel}</div>
                
                <!-- æ”¶èµ·çŠ¶æ€ - æ˜¾ç¤ºå¯ç¼–è¾‘æ‘˜è¦ -->
                <div class="llm-summary">
                    <div style="margin-bottom: 10px;">
                        <strong style="color: #2e7d32; font-size: 13px;">ğŸ¯ å¤„ç†åè¾“å‡º (å¯ç¼–è¾‘):</strong><br>
                        <div class="llm-processed-output-summary" contenteditable="true" style="margin-top: 8px; white-space: pre-wrap; line-height: 1.5; color: #333; font-size: 13px; background: rgba(76, 175, 80, 0.05); border: 1px solid rgba(76, 175, 80, 0.2); border-radius: 4px; padding: 8px; transition: all 0.2s;" data-card-id="${cardId}" onblur="updateLLMContent(this)" onclick="event.stopPropagation()">${processedOutput}</div>
                    </div>
                </div>
                
                <!-- å±•å¼€çŠ¶æ€ - æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ -->
                <div class="llm-details">
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #2e7d32; font-size: 14px;">ğŸ¯ å¤„ç†åè¾“å‡º (å¯ç¼–è¾‘):</strong>
                        <div class="llm-processed-output" contenteditable="true" style="margin-top: 8px; white-space: pre-wrap; line-height: 1.6; color: #333; font-size: 14px; background: rgba(76, 175, 80, 0.05); border: 1px solid rgba(76, 175, 80, 0.2); border-radius: 4px; padding: 10px; transition: all 0.2s;" data-card-id="${cardId}" onblur="updateLLMContent(this)" onclick="event.stopPropagation()">${processedOutput}</div>
                    </div>
                
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #2e7d32; font-size: 14px;">ğŸ¤– LLMåŸå§‹è¿”å›:</strong>
                        <div style="margin-top: 8px; white-space: pre-wrap; line-height: 1.6; color: #333; font-size: 14px;">${result.response}</div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <strong style="color: #1565c0; font-size: 13px;">ğŸ“ æ‚¨çš„è¯·æ±‚:</strong>
                        <div style="margin-top: 6px; font-size: 13px; color: #555; white-space: pre-wrap; line-height: 1.5;">${userInput}</div>
                    </div>
                    
                    <div>
                        <strong style="color: #7b1fa2; font-size: 12px;">âš™ï¸ System Prompt:</strong>
                        <div style="margin-top: 4px; font-size: 12px; color: #666; white-space: pre-wrap; line-height: 1.4;">${systemPrompt}</div>
                    </div>
                </div>
                
                <div class="llm-toggle-indicator"></div>
            `;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            responseCard.onclick = function () {
                toggleLLMCard(cardId);
            };

            llmContainer.appendChild(responseCard);
            llmContainer.scrollTop = llmContainer.scrollHeight;
        }

        // æ·»åŠ å†…å®¹åˆ°ç”¨æˆ·ç•Œé¢
        function addToUserInterface(content, timestamp, isAuto = false) {
            const userInterfaceTextarea = document.getElementById('userInterface');

            // æ›´æ–°ç”¨æˆ·ç•Œé¢å†…å®¹å˜é‡
            userInterfaceContent += content;

            // ç›´æ¥æ›´æ–°textareaçš„å†…å®¹
            userInterfaceTextarea.value = userInterfaceContent;

            // æ»šåŠ¨åˆ°åº•éƒ¨
            userInterfaceTextarea.scrollTop = userInterfaceTextarea.scrollHeight;

            log(`ç”¨æˆ·ç•Œé¢å·²æ·»åŠ å†…å®¹: "${content}"`, 'success');
        }

        function createLLMErrorCard(error, userInput, systemPrompt, isAuto = false) {
            const llmContainer = document.getElementById('llmResponses');
            llmResponseCounter++;

            const errorCard = document.createElement('div');
            errorCard.className = 'event-card llm-response-card';
            const errorCardId = `llm-error-${llmResponseCounter}`;
            errorCard.id = errorCardId;
            errorCard.style.borderColor = '#f44336';
            errorCard.style.background = 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)';

            const errorPreview = error.message.length > 80 ?
                error.message.substring(0, 80) + '...' : error.message;

            const autoLabel = isAuto ? ' [è‡ªåŠ¨]' : '';

            errorCard.innerHTML = `
                <div class="event-header">${formatCurrentTime()} - è¯·æ±‚å¤±è´¥${autoLabel}</div>
                
                <!-- æ”¶èµ·çŠ¶æ€ - æ˜¾ç¤ºé”™è¯¯æ‘˜è¦ -->
                <div class="llm-summary">
                    <div style="color: #d32f2f; padding: 10px; background: rgba(244, 67, 54, 0.1); border-left: 4px solid #f44336; border-radius: 4px;">
                        <strong>âŒ é”™è¯¯:</strong><br>
                        <span style="font-size: 13px; margin-top: 5px; display: block; font-style: italic;">${errorPreview}</span>
                    </div>
                </div>
                
                <!-- å±•å¼€çŠ¶æ€ - æ˜¾ç¤ºå®Œæ•´é”™è¯¯ä¿¡æ¯å’Œè¯·æ±‚è¯¦æƒ… -->
                <div class="llm-details">
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #d32f2f; font-size: 14px;">âŒ å®Œæ•´é”™è¯¯ä¿¡æ¯:</strong>
                        <div style="margin-top: 8px; font-size: 14px; color: #d32f2f; white-space: pre-wrap; line-height: 1.5;">${error.message}</div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <strong style="color: #1565c0; font-size: 13px;">ğŸ“ æ‚¨çš„è¯·æ±‚:</strong>
                        <div style="margin-top: 6px; font-size: 13px; color: #555; white-space: pre-wrap; line-height: 1.5;">${userInput}</div>
                    </div>
                    
                    <div>
                        <strong style="color: #7b1fa2; font-size: 12px;">âš™ï¸ System Prompt:</strong>
                        <div style="margin-top: 4px; font-size: 12px; color: #666; white-space: pre-wrap; line-height: 1.4;">${systemPrompt}</div>
                    </div>
                </div>
                
                <div class="llm-toggle-indicator"></div>
            `;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            errorCard.onclick = function () {
                toggleLLMCard(errorCardId);
            };

            llmContainer.appendChild(errorCard);
            llmContainer.scrollTop = llmContainer.scrollHeight;
        }

        // åˆ‡æ¢æ§åˆ¶é¢æ¿
        function togglePanel() {
            const panel = document.getElementById('controlPanel');
            panel.classList.toggle('show');
        }

        // æµ‹è¯•ç¥¨æ®è¾“å…¥æ¡†æ˜¯å¦å¯è§
        function testTicketField() {
            const wsTicketField = document.getElementById('wsTicket');
            const wsUrl = document.getElementById('wsUrl');
            const panel = document.getElementById('controlPanel');

            console.log('ç¥¨æ®è¾“å…¥æ¡†æµ‹è¯•:');
            console.log('- wsTicketå­—æ®µå­˜åœ¨:', !!wsTicketField);
            console.log('- wsUrlå­—æ®µå­˜åœ¨:', !!wsUrl);
            console.log('- æ§åˆ¶é¢æ¿å­˜åœ¨:', !!panel);
            console.log('- wsUrlå½“å‰å€¼:', wsUrl ? wsUrl.value : 'null');
            console.log('- wsTicketå½“å‰å€¼:', wsTicketField ? wsTicketField.value : 'null');

            // å¼ºåˆ¶æ˜¾ç¤ºæ§åˆ¶é¢æ¿æ¥æ£€æŸ¥
            if (panel && !panel.classList.contains('show')) {
                panel.classList.add('show');
                console.log('å·²å¼ºåˆ¶æ˜¾ç¤ºæ§åˆ¶é¢æ¿');
            }
        }

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const logEl = document.getElementById('settingsLog');
            if (!logEl) return;

            const color = type === 'error' ? '#ff4444' :
                type === 'success' ? '#44ff44' :
                    type === 'warning' ? '#ffaa44' : '#44ffff';
            logEl.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;

            // é™åˆ¶æ—¥å¿—é•¿åº¦
            const lines = logEl.innerHTML.split('\n');
            if (lines.length > 100) {
                logEl.innerHTML = lines.slice(-100).join('\n');
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateConnectionStatus(status) {
            const indicator = document.querySelector('.status-indicator');
            if (indicator) {
                indicator.className = `status-indicator ${status}`;
            }
        }

        // è·å–WebSocketç¥¨æ®
        async function getWebSocketTicket() {
            try {
                log('æ­£åœ¨è·å–WebSocketç¥¨æ®...', 'info');

                const headers = {
                    'Content-Type': 'application/json'
                };

                // å¦‚æœæœ‰JWT Tokenï¼Œåˆ™ä½¿ç”¨è®¤è¯æ–¹å¼
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                    log('ä½¿ç”¨JWT Tokenè®¤è¯è·å–ç¥¨æ®', 'info');
                } else {
                    log('âš ï¸ æ— JWT Tokenï¼Œå°è¯•æ— è®¤è¯æ–¹å¼è·å–ç¥¨æ®ï¼ˆå¯èƒ½å¤±è´¥ï¼‰', 'warning');
                }

                const response = await fetch('/api/ws/ticket', {
                    method: 'POST',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const ticket = data.ticket;

                if (ticket) {
                    document.getElementById('wsTicket').value = ticket;
                    saveSettings(); // ä¿å­˜ç¥¨æ®åˆ°æœ¬åœ°å­˜å‚¨
                    log('WebSocketç¥¨æ®è·å–æˆåŠŸ', 'success');
                    log(`ç¥¨æ®æœ‰æ•ˆæœŸ: ${data.expires_in || 'N/A'} ç§’`, 'info');

                    if (!authToken) {
                        log('ğŸ’¡ æç¤º: å»ºè®®é…ç½®Clerkè®¤è¯ä»¥è·å¾—æ›´å¥½çš„å®‰å…¨æ€§', 'info');
                    }
                } else {
                    throw new Error('å“åº”ä¸­æ²¡æœ‰æ‰¾åˆ°ç¥¨æ®');
                }

            } catch (error) {
                log(`è·å–WebSocketç¥¨æ®å¤±è´¥: ${error.message}`, 'error');

                // å¦‚æœæ˜¯401é”™è¯¯ä¸”æœ‰authTokenï¼Œå¯èƒ½æ˜¯tokenè¿‡æœŸ
                if (error.message.includes('401') && authToken) {
                    log('JWT Token å¯èƒ½å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–', 'warning');
                } else if (error.message.includes('401') && !authToken) {
                    log('éœ€è¦è®¤è¯æ‰èƒ½è·å–ç¥¨æ®ï¼Œè¯·å…ˆé…ç½®Clerkå¹¶å®Œæˆç™»å½•', 'warning');
                }
            }
        }

        // æµ‹è¯•WebSocketè¿æ¥
        async function testWebSocketConnection() {
            let url = document.getElementById('wsUrl').value;
            if (!url) {
                log('è¯·è¾“å…¥WebSocketæœåŠ¡å™¨åœ°å€', 'error');
                return;
            }

            // è½¬æ¢ç›¸å¯¹è·¯å¾„ä¸ºå®Œæ•´çš„WebSocket URL
            if (url.startsWith('/')) {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host;
                url = `${protocol}//${host}${url}`;
            }

            log(`æµ‹è¯•è¿æ¥: ${url}`, 'info');

            try {
                const testWs = new WebSocket(url);

                const timeout = setTimeout(() => {
                    testWs.close();
                    log('è¿æ¥æµ‹è¯•è¶…æ—¶', 'error');
                }, 5000);

                testWs.onopen = () => {
                    clearTimeout(timeout);
                    log('è¿æ¥æµ‹è¯•æˆåŠŸ! æœåŠ¡å™¨å¯è®¿é—®', 'success');
                    testWs.close();
                };

                testWs.onerror = (error) => {
                    clearTimeout(timeout);
                    log('è¿æ¥æµ‹è¯•å¤±è´¥: æœåŠ¡å™¨ä¸å¯è®¿é—®', 'error');
                };

                testWs.onclose = () => {
                    clearTimeout(timeout);
                };
            } catch (error) {
                log(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åº”ç”¨VADé…ç½®
        async function applyVADConfig() {
            try {
                log('æ­£åœ¨åº”ç”¨VADé…ç½®...', 'info');

                // é”€æ¯æ—§çš„VADå®ä¾‹
                if (window.globalStreamingVAD) {
                    window.globalStreamingVAD.destroy();
                    window.globalStreamingVAD = null;
                }

                // è·å–æ–°çš„VADé…ç½®å‚æ•°
                const vadConfig = {
                    hopMs: parseInt(document.getElementById('hopMs').value),
                    threshold: parseFloat(document.getElementById('threshold').value),
                    prefixMs: parseInt(document.getElementById('prefixMs').value),
                    silenceMs: parseInt(document.getElementById('silenceMs').value),
                    asrTriggerMs: parseInt(document.getElementById('asrTriggerMs').value),
                    enablePrefetch: document.getElementById('enablePrefetch').checked,
                    sampleRate: 16000
                };

                // åˆ›å»ºæ–°çš„VADå®ä¾‹
                const config = new window.VADConfig(vadConfig);
                window.globalStreamingVAD = new window.StreamingVAD(config);
                await window.globalStreamingVAD.init();
                window.vadEvents = [];

                vadInitialized = true;
                log('VADé…ç½®å·²åº”ç”¨', 'success');

                // ä¿å­˜è®¾ç½®
                saveSettings();
            } catch (error) {
                log(`åº”ç”¨VADé…ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆå§‹åŒ–VADï¼ˆé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œï¼‰
        async function initVAD() {
            try {
                log('æ­£åœ¨åˆå§‹åŒ–VAD...', 'info');

                const vadConfig = {
                    hopMs: parseInt(document.getElementById('hopMs').value),
                    threshold: parseFloat(document.getElementById('threshold').value),
                    prefixMs: parseInt(document.getElementById('prefixMs').value),
                    silenceMs: parseInt(document.getElementById('silenceMs').value),
                    asrTriggerMs: parseInt(document.getElementById('asrTriggerMs').value),
                    enablePrefetch: document.getElementById('enablePrefetch').checked,
                    sampleRate: 16000
                };

                log(`VADé…ç½®: threshold=${vadConfig.threshold}, prefixMs=${vadConfig.prefixMs}, speechFrames=${Math.floor(vadConfig.prefixMs / vadConfig.hopMs)}`, 'info');

                const config = new window.VADConfig(vadConfig);
                window.globalStreamingVAD = new window.StreamingVAD(config);
                await window.globalStreamingVAD.init();
                window.vadEvents = [];

                vadInitialized = true;
                log('VADåˆå§‹åŒ–æˆåŠŸ - éœ€è¦è¿ç»­è¯­éŸ³æ£€æµ‹æ‰èƒ½è§¦å‘startäº‹ä»¶', 'success');
            } catch (error) {
                log(`VADåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ·»åŠ åŠ è½½åŠ¨ç”»æ ·å¼
        const spinnerStyle = document.createElement('style');
        spinnerStyle.textContent = `
            .spinner {
                display: inline-block;
                width: 14px;
                height: 14px;
                border: 2px solid #ffffff;
                border-radius: 50%;
                border-top-color: transparent;
                animation: spin 0.8s linear infinite;
                margin-right: 6px;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(spinnerStyle);

        // åˆ‡æ¢å½•éŸ³çŠ¶æ€
        async function toggleRecording() {
            console.log('toggleRecording è¢«è°ƒç”¨, isRecording:', isRecording);
            log('å½•éŸ³æŒ‰é’®è¢«ç‚¹å‡»', 'info');

            if (isRecording) {
                await handleStopRecording();
            } else {
                await handleStartRecording();
            }
        }

        // å¼€å§‹å½•éŸ³å¤„ç†
        async function handleStartRecording() {
            const recordBtn = document.getElementById('recordBtn');
            const originalBtnText = recordBtn.querySelector('.record-text').textContent;

            try {
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                recordBtn.querySelector('.record-text').innerHTML = '<span class="spinner"></span>æ­£åœ¨è¿æ¥...';

                // å…ˆè¿æ¥WebSocket
                let url = document.getElementById('wsUrl').value;
                if (!url) {
                    throw new Error('è¯·è¾“å…¥WebSocketæœåŠ¡å™¨åœ°å€');
                }

                // è½¬æ¢ç›¸å¯¹è·¯å¾„ä¸ºå®Œæ•´çš„WebSocket URL
                if (url.startsWith('/')) {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const host = window.location.host;
                    url = `${protocol}//${host}${url}`;
                }

                log(`æ­£åœ¨è¿æ¥WebSocket: ${url}`, 'info');

                // å¦‚æœå·²è¿æ¥ï¼Œå…ˆæ–­å¼€
                if (isConnected) {
                    window.disconnectWebSocket();
                    isConnected = false;
                    await new Promise(resolve => setTimeout(resolve, 100)); // ç­‰å¾…æ–­å¼€å®Œæˆ
                }

                // è·å–ç¥¨æ®
                const ticket = document.getElementById('wsTicket').value;
                if (!ticket || !ticket.trim()) {
                    throw new Error('è¯·å…ˆè·å–WebSocketç¥¨æ®');
                }

                // è¿æ¥WebSocket 
                const wsSuccess = await window.connectWebSocket(url, ticket.trim());
                if (!wsSuccess) {
                    throw new Error('WebSocketè¿æ¥å¤±è´¥');
                }

                isConnected = true;
                log('WebSocketè¿æ¥æˆåŠŸ', 'success');

                // é‡ç½®VADçŠ¶æ€
                if (window.globalStreamingVAD) {
                    window.globalStreamingVAD.reset();
                    window.vadEvents = [];
                    log('VADçŠ¶æ€å·²é‡ç½®', 'info');
                }

                // æ¸…ç©ºå¡ç‰‡å†…å®¹
                clearCards();

                // å¼€å§‹å½•éŸ³
                log('æ­£åœ¨å¯åŠ¨å½•éŸ³...', 'info');
                const recordSuccess = await window.startRecording();

                if (recordSuccess) {
                    isRecording = true;
                    const timeoutSec = parseInt(document.getElementById('silenceTimeoutSec').value) || 10;
                    log('å½•éŸ³å¼€å§‹ï¼ŒéŸ³é¢‘æµä¼ è¾“ä¸­...', 'success');
                    log(`æç¤ºï¼šé™éŸ³è¶…è¿‡${timeoutSec}ç§’å°†è‡ªåŠ¨åœæ­¢å½•éŸ³`, 'info');

                    // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                    lastVADEndTime = null;

                    // æ›´æ–°æ‚¬æµ®æŒ‰é’®çŠ¶æ€
                    const recordBtn = document.getElementById('recordBtn');
                    recordBtn.classList.add('recording');
                    recordBtn.querySelector('.record-text').textContent = 'åœæ­¢å½•éŸ³';
                    recordBtn.querySelector('.record-icon').textContent = 'â¹';
                    recordBtn.disabled = false;
                } else {
                    throw new Error('å½•éŸ³å¯åŠ¨å¤±è´¥');
                }
            } catch (error) {
                log(`å¼€å§‹å½•éŸ³å¤±è´¥: ${error.message}`, 'error');

                // æ¢å¤æ‚¬æµ®æŒ‰é’®çŠ¶æ€
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.classList.remove('recording');
                recordBtn.querySelector('.record-text').textContent = 'å¼€å§‹å½•éŸ³';
                recordBtn.querySelector('.record-icon').textContent = 'ğŸ¤';
                recordBtn.disabled = false;

                // å¦‚æœè¿æ¥äº†ä½†å½•éŸ³å¤±è´¥ï¼Œæ–­å¼€è¿æ¥
                if (isConnected && !isRecording) {
                    window.disconnectWebSocket();
                    isConnected = false;
                }
            }
        }

        // åœæ­¢å½•éŸ³å¤„ç†
        async function handleStopRecording() {
            try {
                // æ¸…é™¤é™éŸ³è®¡æ—¶å™¨
                clearTimeout(silenceTimer);
                silenceTimer = null;
                lastVADEndTime = null;

                await window.stopRecording();
                isRecording = false;

                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿endAudioStreamå®ŒæˆWebSocketå…³é—­
                setTimeout(() => {
                    isConnected = window.isWebSocketConnected();
                    if (isConnected) {
                        log('WebSocketä»ç„¶è¿æ¥ä¸­ï¼Œæ‰‹åŠ¨æ–­å¼€', 'warning');
                        window.disconnectWebSocket();
                        isConnected = false;
                    }
                }, 500); // ç»™500msæ—¶é—´è®©endAudioStreamå®Œæˆ

                log('å½•éŸ³å·²åœæ­¢', 'info');

                // æ¢å¤æ‚¬æµ®æŒ‰é’®çŠ¶æ€
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.classList.remove('recording');
                recordBtn.querySelector('.record-text').textContent = 'å¼€å§‹å½•éŸ³';
                recordBtn.querySelector('.record-icon').textContent = 'ğŸ¤';
                recordBtn.disabled = false;
            } catch (error) {
                log(`åœæ­¢å½•éŸ³å¤±è´¥: ${error.message}`, 'error');

                // å‘ç”Ÿé”™è¯¯æ—¶ç¡®ä¿è¿æ¥çŠ¶æ€æ­£ç¡®
                isConnected = false;
                if (window.isWebSocketConnected && window.isWebSocketConnected()) {
                    window.disconnectWebSocket();
                }
            }
        }

        // åˆ‡æ¢ASRå¡ç‰‡é€‰ä¸­çŠ¶æ€
        function toggleASRSelection(cardId) {
            const card = document.getElementById(cardId);
            if (!card || card.classList.contains('dropped')) return; // è¢«ä¸¢å¼ƒçš„å¡ç‰‡ä¸èƒ½é€‰ä¸­

            if (selectedASRCards.has(cardId)) {
                selectedASRCards.delete(cardId);
                card.classList.remove('selected');
            } else {
                selectedASRCards.add(cardId);
                card.classList.add('selected');
            }

            // æ›´æ–°é€‰ä¸­è®¡æ•°å’Œæ˜¾ç¤ºæäº¤æŒ‰é’®
            const count = selectedASRCards.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('asrActions').style.display = count > 0 ? 'block' : 'none';
        }

        // ASR Promptå¤„ç†å‡½æ•°
        function processASRPrompt(asrPromptTemplate) {
            if (!asrPromptTemplate.trim()) {
                return '';
            }

            // è·å–æ‰€æœ‰ASRå¡ç‰‡ï¼ŒæŒ‰æ—¶é—´é¡ºåºæ’åºï¼ˆæœ€æ–°çš„æ˜¯0ï¼‰
            const allCards = Array.from(asrTextMap.keys()).sort((a, b) => {
                const cardNumA = parseInt(a.split('-')[2]);
                const cardNumB = parseInt(b.split('-')[2]);
                return cardNumB - cardNumA; // é™åºï¼Œæœ€æ–°çš„åœ¨å‰
            });

            log(`ASR Promptå¤„ç†: åŸå§‹æ¨¡æ¿ = "${asrPromptTemplate}"`, 'info');
            log(`å¯ç”¨å¡ç‰‡: ${allCards.map(id => `${id}="${asrTextMap.get(id)}"`).join(', ')}`, 'info');

            let processedPrompt = asrPromptTemplate;

            // å¤„ç† $*_asr - å…¨æ–‡æ‹¼æ¥
            const allAsrTexts = allCards.map(cardId => asrTextMap.get(cardId) || '').filter(text => text.trim()).join('');
            processedPrompt = processedPrompt.replaceAll('$*_asr', allAsrTexts);

            // å¤„ç† $*_llm - å…¨æ–‡æ‹¼æ¥ï¼ˆä½¿ç”¨ç¼–è¾‘åçš„è¾“å‡ºï¼‰
            const allLlmOutputs = llmResponsesData.map(data => data.modifiedProcessedOutput || '').filter(text => text.trim()).join('');
            processedPrompt = processedPrompt.replaceAll('$*_llm', allLlmOutputs);

            // æŸ¥æ‰¾ASR Promptä¸­çš„æ•°å­—ç´¢å¼•å˜é‡
            const indexMatches = asrPromptTemplate.match(/\$(\d+)_(asr|llm)/g);
            const indices = new Set();
            if (indexMatches) {
                indexMatches.forEach(match => {
                    const index = parseInt(match.match(/\d+/)[0]);
                    indices.add(index);
                });
            }

            // æ›¿æ¢æ‰€æœ‰ç´¢å¼•å˜é‡
            indices.forEach(i => {
                // ASR å˜é‡
                const cardId = allCards[i];
                const asrText = cardId ? (asrTextMap.get(cardId) || '') : '';
                processedPrompt = processedPrompt.replaceAll(`$${i}_asr`, asrText);

                // LLM å˜é‡ - ä½¿ç”¨ç¼–è¾‘åçš„è¾“å‡ºï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
                const llmIndex = llmResponsesData.length - 1 - i; // å€’åºç´¢å¼•
                const llmData = llmIndex >= 0 ? llmResponsesData[llmIndex] : null;
                const llmOutput = llmData ? (llmData.modifiedProcessedOutput || '') : '';
                processedPrompt = processedPrompt.replaceAll(`$${i}_llm`, llmOutput);

                log(`æ›¿æ¢ $${i}_asr -> "${asrText}", $${i}_llm -> "${llmOutput}" (llmIndex: ${llmIndex}/${llmResponsesData.length})`, 'info');
            });

            // æ›¿æ¢ $user_interface
            processedPrompt = processedPrompt.replaceAll('$user_interface', userInterfaceContent);

            log(`ASR Promptå¤„ç†å®Œæˆ: "${processedPrompt}"`, 'success');
            // ä¿å­˜ç”Ÿæˆçš„promptä¾›åç»­ä½¿ç”¨
            lastGeneratedASRPrompt = processedPrompt;
            return processedPrompt;
        }

        // Input Ruleå¤„ç†å‡½æ•°
        function processInputRule(inputRule, selectedCards = null) {
            if (!inputRule.trim()) {
                if (selectedCards) {
                    // æ‰‹åŠ¨é€‰æ‹©çš„å¡ç‰‡ï¼Œä½¿ç”¨é»˜è®¤çš„'\n'.joinæ–¹å¼
                    const selectedTexts = [];
                    selectedCards.forEach(cardId => {
                        const text = asrTextMap.get(cardId);
                        if (text) {
                            selectedTexts.push(text);
                        }
                    });
                    return selectedTexts.join('\n');
                } else {
                    // è‡ªåŠ¨LLMï¼Œä½¿ç”¨æœ€æ–°ä¸€å¥è¯
                    const allCards = Array.from(asrTextMap.keys()).sort((a, b) => {
                        const cardNumA = parseInt(a.split('-')[2]); // asr-card-N ä¸­çš„N
                        const cardNumB = parseInt(b.split('-')[2]);
                        return cardNumB - cardNumA; // é™åºï¼Œæœ€æ–°çš„åœ¨å‰ï¼ˆcardIdCounterè¶Šå¤§è¶Šæ–°ï¼‰
                    });
                    if (allCards.length > 0) {
                        return asrTextMap.get(allCards[0]) || '';
                    }
                    return '';
                }
            }

            // è·å–æ‰€æœ‰ASRå¡ç‰‡ï¼ŒæŒ‰æ—¶é—´é¡ºåºæ’åºï¼ˆæœ€æ–°çš„æ˜¯0ï¼‰
            // ä½¿ç”¨cardIdCounteræ’åºï¼Œå› ä¸ºå®ƒæ˜¯æŒ‰æ—¶é—´é€’å¢çš„
            const allCards = Array.from(asrTextMap.keys()).sort((a, b) => {
                const cardNumA = parseInt(a.split('-')[2]); // asr-card-N ä¸­çš„N
                const cardNumB = parseInt(b.split('-')[2]);
                return cardNumB - cardNumA; // é™åºï¼Œæœ€æ–°çš„åœ¨å‰ï¼ˆcardIdCounterè¶Šå¤§è¶Šæ–°ï¼‰
            });

            log(`Input Ruleå¤„ç†: åŸå§‹æ¨¡æ¿ = "${inputRule}"`, 'info');
            log(`å¯ç”¨å¡ç‰‡: ${allCards.map(id => `${id}="${asrTextMap.get(id)}"`).join(', ')}`, 'info');

            let processedRule = inputRule;

            // å¤„ç† $*_asr - å…¨æ–‡æ‹¼æ¥
            const allAsrTexts = allCards.map(cardId => asrTextMap.get(cardId) || '').filter(text => text.trim()).join('');
            processedRule = processedRule.replaceAll('$*_asr', allAsrTexts);

            // å¤„ç† $*_llm - å…¨æ–‡æ‹¼æ¥ï¼ˆä½¿ç”¨ç¼–è¾‘åçš„è¾“å‡ºï¼‰
            const allLlmOutputs = llmResponsesData.map(data => data.modifiedProcessedOutput || '').filter(text => text.trim()).join('');
            processedRule = processedRule.replaceAll('$*_llm', allLlmOutputs);

            // æŸ¥æ‰¾Input Ruleä¸­çš„æ•°å­—ç´¢å¼•å˜é‡
            const indexMatches = inputRule.match(/\$(\d+)_(asr|llm)/g);
            const indices = new Set();
            if (indexMatches) {
                indexMatches.forEach(match => {
                    const index = parseInt(match.match(/\d+/)[0]);
                    indices.add(index);
                });
            }

            // æ›¿æ¢æ‰€æœ‰ç´¢å¼•å˜é‡
            indices.forEach(i => {
                // ASR å˜é‡
                const cardId = allCards[i]; // æŒ‰æ—¶é—´é¡ºåºï¼Œæœ€æ–°çš„æ˜¯ç´¢å¼•0
                const asrText = cardId ? (asrTextMap.get(cardId) || '') : '';

                processedRule = processedRule.replaceAll(`$${i}_asr`, asrText);

                // LLM å˜é‡ - ä½¿ç”¨ç¼–è¾‘åçš„è¾“å‡ºï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
                const llmIndex = llmResponsesData.length - 1 - i; // å€’åºç´¢å¼•ï¼Œæœ€æ–°çš„æ˜¯ç´¢å¼•0
                const llmData = llmIndex >= 0 ? llmResponsesData[llmIndex] : null;
                const llmOutput = llmData ? (llmData.modifiedProcessedOutput || '') : '';
                processedRule = processedRule.replaceAll(`$${i}_llm`, llmOutput);

                log(`æ›¿æ¢ $${i}_asr -> "${asrText}", $${i}_llm -> "${llmOutput}" (llmIndex: ${llmIndex}/${llmResponsesData.length})`, 'info');
            });

            // æ›¿æ¢ $user_interface
            processedRule = processedRule.replaceAll('$user_interface', userInterfaceContent);

            log(`Input Ruleå¤„ç†å®Œæˆ: "${processedRule}"`, 'success');
            return processedRule;
        }

        // Output Ruleå¤„ç†å‡½æ•°
        function processOutputRule(llmResponse, outputRule) {
            if (!outputRule.trim()) {
                // å¦‚æœæ²¡æœ‰Output Ruleï¼Œè¿”å›åŸå§‹å“åº”
                return llmResponse;
            }

            log(`Output Ruleå¤„ç†: åŸå§‹æ¨¡æ¿ = "${outputRule}"`, 'info');
            log(`LLMå“åº”: "${llmResponse}"`, 'info');

            // å°è¯•å¤šç§JSONæ ¼å¼è§£æ
            let jsonMatch = null;
            let jsonContent = {};

            // 1. å…ˆå°è¯•åŒ¹é… ```json{...}``` æ ¼å¼
            jsonMatch = llmResponse.match(/```json\s*([\s\S]*?)\s*```/);

            // 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åŒ¹é… ```{...}``` æ ¼å¼
            if (!jsonMatch) {
                jsonMatch = llmResponse.match(/```\s*([\s\S]*?)\s*```/);
            }

            // 3. å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œå°è¯•ç›´æ¥è§£ææ•´ä¸ªå“åº”ä¸­çš„JSONå¯¹è±¡
            if (!jsonMatch) {
                // å¯»æ‰¾å“åº”ä¸­çš„JSONå¯¹è±¡ï¼ˆä»¥{å¼€å¤´ï¼Œä»¥}ç»“å°¾ï¼‰
                const jsonObjectMatch = llmResponse.match(/\{[\s\S]*\}/);
                if (jsonObjectMatch) {
                    jsonMatch = [null, jsonObjectMatch[0]]; // æ„é€ åŒ¹é…ç»“æœæ ¼å¼
                }
            }

            if (jsonMatch) {
                try {
                    jsonContent = JSON.parse(jsonMatch[1]);
                    log(`è§£æJSONæˆåŠŸ: ${JSON.stringify(jsonContent)}`, 'success');
                } catch (error) {
                    log(`JSONè§£æå¤±è´¥: ${error.message}`, 'error');
                    return llmResponse; // è§£æå¤±è´¥ï¼Œè¿”å›åŸå§‹å“åº”
                }
            } else {
                log('æœªæ‰¾åˆ°JSONå†…å®¹ï¼Œè¿”å›åŸå§‹å“åº”', 'warning');
                return llmResponse;
            }

            let processedOutput = outputRule;

            // æŸ¥æ‰¾æ‰€æœ‰å˜é‡å¼•ç”¨ $key æˆ– $key[index]
            const variableMatches = outputRule.match(/\$([a-zA-Z_][a-zA-Z0-9_]*)\[?(\d+)?\]?/g);

            if (variableMatches) {
                variableMatches.forEach(match => {
                    const fullMatch = match;
                    const varMatch = match.match(/\$([a-zA-Z_][a-zA-Z0-9_]*)(\[(\d+)\])?/);

                    if (varMatch) {
                        const varName = varMatch[1];
                        const arrayIndex = varMatch[3] ? parseInt(varMatch[3]) : null;

                        if (jsonContent.hasOwnProperty(varName)) {
                            let value = jsonContent[varName];

                            // å¦‚æœæŒ‡å®šäº†æ•°ç»„ç´¢å¼•
                            if (arrayIndex !== null) {
                                if (Array.isArray(value) && arrayIndex < value.length) {
                                    value = value[arrayIndex];
                                } else {
                                    value = ''; // ç´¢å¼•è¶…å‡ºèŒƒå›´æˆ–ä¸æ˜¯æ•°ç»„
                                }
                            }

                            // å¦‚æœvalueæ˜¯å¯¹è±¡æˆ–æ•°ç»„ï¼Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²
                            if (typeof value === 'object') {
                                value = JSON.stringify(value);
                            } else {
                                value = String(value);
                            }

                            processedOutput = processedOutput.replaceAll(fullMatch, value);
                            log(`æ›¿æ¢ ${fullMatch} -> "${value}"`, 'info');
                        } else {
                            // å˜é‡ä¸å­˜åœ¨ï¼Œæ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²
                            processedOutput = processedOutput.replaceAll(fullMatch, '');
                            log(`å˜é‡ ${varName} ä¸å­˜åœ¨ï¼Œæ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²`, 'warning');
                        }
                    }
                });
            }

            log(`Output Ruleå¤„ç†å®Œæˆ: "${processedOutput}"`, 'success');
            return processedOutput;
        }

        // æäº¤åˆ°LLM
        async function submitToLLM() {
            if (selectedASRCards.size === 0) {
                log('è¯·å…ˆé€‰æ‹©è¦æäº¤çš„ASRç»“æœ', 'warning');
                return;
            }

            // ä½¿ç”¨Input Ruleå¤„ç†é€‰ä¸­çš„å¡ç‰‡
            const inputRule = document.getElementById('inputRule').value;
            const userInput = processInputRule(inputRule, selectedASRCards);
            const systemPrompt = document.getElementById('llmPrompt').value || 'ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹ã€‚';

            log(`å‡†å¤‡æäº¤${selectedASRCards.size}æ¡ASRç»“æœåˆ°LLM`, 'info');
            log(`System Prompt: ${systemPrompt}`, 'info');
            log(`User Input: ${userInput}`, 'info');

            // å®é™…çš„LLM APIè°ƒç”¨
            const llmContainer = document.getElementById('llmResponses');
            if (llmContainer.querySelector('.empty-state')) {
                llmContainer.innerHTML = '';
            }

            // åˆ›å»ºåŠ è½½ä¸­çš„å“åº”å¡ç‰‡
            const loadingCardId = `llm-loading-${Date.now()}`;
            const loadingCard = document.createElement('div');
            loadingCard.className = 'event-card llm-response-card';
            loadingCard.id = loadingCardId;
            loadingCard.innerHTML = `
                <div class="event-header">${formatCurrentTime()} - æ­£åœ¨å¤„ç†...</div>
                <div class="llm-content">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="spinner"></span>
                        <strong>ğŸ¤– æ­£åœ¨è¯·æ±‚LLMå“åº”...</strong>
                    </div>
                </div>
            `;
            llmContainer.appendChild(loadingCard);
            llmContainer.scrollTop = llmContainer.scrollHeight;

            try {
                log('æ­£åœ¨è¯·æ±‚LLM...', 'info');

                const llmUrl = document.getElementById('llmUrl').value || 'https://api.frapp.ai/llm';
                const llmModel = document.getElementById('llmModel').value || 'gemini2.5';

                const response = await fetch(llmUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        system_prompt: systemPrompt,
                        content: userInput,
                        model: llmModel,
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                log('LLMå“åº”æˆåŠŸ', 'success');

                // ç§»é™¤åŠ è½½å¡ç‰‡
                loadingCard.remove();

                // ä½¿ç”¨ç»Ÿä¸€çš„åˆ›å»ºå‡½æ•°
                createLLMResponseCard(result, userInput, systemPrompt, false);

            } catch (error) {
                log(`LLMè¯·æ±‚å¤±è´¥: ${error.message}`, 'error');

                // ç§»é™¤åŠ è½½å¡ç‰‡
                loadingCard.remove();

                // ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¡ç‰‡åˆ›å»ºå‡½æ•°
                createLLMErrorCard(error, userInput, systemPrompt, false);
            }

            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            selectedASRCards.forEach(cardId => {
                const card = document.getElementById(cardId);
                if (card) {
                    card.classList.remove('selected');
                }
            });
            selectedASRCards.clear();
            document.getElementById('selectedCount').textContent = '0';
            document.getElementById('asrActions').style.display = 'none';
        }

        // æ¸…ç©ºå››å¼ å¡ç‰‡ï¼ˆä¸åŒ…æ‹¬æ—¥å¿—ï¼‰
        function clearCards() {
            document.getElementById('vadEvents').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ¤</div><div>ç­‰å¾…VADäº‹ä»¶...</div></div>';
            document.getElementById('asrResults').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’¬</div><div>ç­‰å¾…è¯­éŸ³è¯†åˆ«...</div></div>';
            document.getElementById('llmResponses').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ¤–</div><div>LLMåŠŸèƒ½å¾…å¼€å‘...</div></div>';
            document.getElementById('userInterface').value = '';
            selectedASRCards.clear();
            asrTextMap.clear();
            asrPromptMap.clear();
            prefetchResults.clear();
            llmResponsesData = [];
            userInterfaceContent = '';

            // é‡ç½®åºå·è®¡æ•°å™¨
            nextSentenceNumber = 1;
            cardIdCounter = 0;

            document.getElementById('selectedCount').textContent = '0';
            document.getElementById('asrActions').style.display = 'none';
            log('å·²æ¸…ç©ºå¡ç‰‡å†…å®¹', 'info');
        }

        // æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼ˆåŒ…æ‹¬æ—¥å¿—ï¼‰
        function clearAll() {
            clearCards(); // æ¸…ç©ºå¡ç‰‡
            document.getElementById('settingsLog').innerHTML = '';
            log('å·²æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼ˆåŒ…æ‹¬æ—¥å¿—ï¼‰', 'info');
        }

        // æ¸…ç©ºVADå¡ç‰‡
        function clearVADCards() {
            document.getElementById('vadEvents').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ¤</div><div>ç­‰å¾…VADäº‹ä»¶...</div></div>';
            log('å·²æ¸…ç©ºVADäº‹ä»¶', 'info');
        }

        // æ¸…ç©ºASRå¡ç‰‡
        function clearASRCards() {
            document.getElementById('asrResults').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’¬</div><div>ç­‰å¾…è¯­éŸ³è¯†åˆ«...</div></div>';
            selectedASRCards.clear();
            asrTextMap.clear();
            asrPromptMap.clear();
            prefetchResults.clear();

            // é‡ç½®åºå·è®¡æ•°å™¨
            nextSentenceNumber = 1;
            cardIdCounter = 0;

            document.getElementById('selectedCount').textContent = '0';
            document.getElementById('asrActions').style.display = 'none';
            log('å·²æ¸…ç©ºASRç»“æœ', 'info');
        }

        // æ¸…ç©ºLLMå¡ç‰‡
        function clearLLMCards() {
            document.getElementById('llmResponses').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ¤–</div><div>LLMåŠŸèƒ½å¾…å¼€å‘...</div></div>';
            llmResponsesData = [];
            log('å·²æ¸…ç©ºLLMå“åº”', 'info');
        }

        // æ¸…ç©ºç”¨æˆ·ç•Œé¢å¡ç‰‡
        function clearUserInterfaceCards() {
            document.getElementById('userInterface').value = '';
            userInterfaceContent = '';
            log('å·²æ¸…ç©ºç”¨æˆ·ç•Œé¢', 'info');
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = ms % 1000;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
        }

        // æ ¼å¼åŒ–å½“å‰æ—¶é—´ï¼ˆåŒ…å«æ¯«ç§’ï¼‰
        function formatCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }) + '.' + now.getMilliseconds().toString().padStart(3, '0');
            return timeString;
        }

        // è·å–äº‹ä»¶emoji
        function getEventEmoji(eventType) {
            const emojis = {
                'start': 'ğŸ—£ï¸',
                'end': 'ğŸ”‡',
                'cache_asr_trigger': 'ğŸš€',
                'cache_asr_drop': 'ğŸ—‘ï¸'
            };
            return emojis[eventType] || 'ğŸ“Š';
        }

        // ç›‘å¬VADäº‹ä»¶
        window.addEventListener('vadEvent', (event) => {
            const data = event.detail;
            const container = document.getElementById('vadEvents');

            // æ¸…é™¤ç©ºçŠ¶æ€æç¤º
            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            // åˆ›å»ºVADäº‹ä»¶å¡ç‰‡
            const card = document.createElement('div');
            card.className = 'event-card vad-event-card';

            const eventType = data.event || 'unknown';
            const emoji = getEventEmoji(eventType);
            const time = formatTime(data.absoluteTimeMs || 0);

            card.innerHTML = `
                <div class="event-header">${data.timestamp || formatCurrentTime()}</div>
                <div class="event-content">
                    ${emoji} ${eventType}: ${time}
                </div>
            `;

            container.appendChild(card);
            container.scrollTop = container.scrollHeight;

            log(`VAD: ${eventType} at ${time}`, 'info');

            // å¤„ç†VADäº‹ä»¶
            if (isRecording) {
                if (eventType === 'end') {
                    // VADç»“æŸï¼Œå¼€å§‹è®¡æ—¶
                    lastVADEndTime = Date.now();
                    clearTimeout(silenceTimer);
                    const timeoutSec = parseInt(document.getElementById('silenceTimeoutSec').value) || 10;
                    silenceTimer = setTimeout(() => {
                        if (isRecording) {
                            log(`é™éŸ³è¶…è¿‡${timeoutSec}ç§’ï¼Œè‡ªåŠ¨åœæ­¢å½•éŸ³`, 'warning');
                            handleStopRecording();
                        }
                    }, timeoutSec * 1000);
                } else if (eventType === 'start') {
                    // VADå¼€å§‹ï¼Œæ¸…é™¤è®¡æ—¶å™¨
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                    lastVADEndTime = null;
                } else if (eventType === 'cache_asr_trigger') {
                    // VAD triggerï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç†å‰ä¸€æ¬¡prefetch
                    log(`æ”¶åˆ°cache_asr_triggeräº‹ä»¶ï¼Œå½“å‰prefetchResultsæ•°é‡: ${prefetchResults.size}`, 'info');
                    if (prefetchResults.size > 0) {
                        log(`æ£€æµ‹åˆ°æœªå¤„ç†çš„prefetchï¼Œä¸»åŠ¨å‘é€dropæ¸…ç†`, 'warning');
                        handleVADDrop();
                    }
                } else if (eventType === 'cache_asr_drop') {
                    // VAD dropï¼Œå¤„ç†é¢„å–å¡ç‰‡
                    log(`æ”¶åˆ°cache_asr_dropäº‹ä»¶ï¼Œå½“å‰prefetchResultsæ•°é‡: ${prefetchResults.size}`, 'warning');
                    handleVADDrop();
                }
            }
        });

        // å¤„ç†VAD dropäº‹ä»¶
        function handleVADDrop() {
            // æŸ¥æ‰¾æœ€æ–°çš„prefetchå¡ç‰‡å¹¶æ·»åŠ å·²ä¸¢å¼ƒæ ·å¼
            const prefetchEntries = Array.from(prefetchResults.entries());
            log(`handleVADDrop: prefetchResultsä¸­æœ‰${prefetchEntries.length}ä¸ªæ¡ç›®: ${prefetchEntries.map(([id, data]) => `${id}(#${data.previewSentenceNumber})`).join(', ')}`, 'info');

            if (prefetchEntries.length === 0) {
                log(`handleVADDrop: prefetchResultsä¸ºç©ºï¼Œæ— æ³•å¤„ç†drop`, 'warning');
                return;
            }

            // æŒ‰å¡ç‰‡IDæ’åºï¼Œå–æœ€æ–°çš„
            const latestPrefetch = prefetchEntries.sort((a, b) => {
                const aId = parseInt(a[0].split('-')[2]);
                const bId = parseInt(b[0].split('-')[2]);
                return bId - aId;
            })[0];

            const [cardId, prefetchData] = latestPrefetch;
            log(`handleVADDrop: å‡†å¤‡dropæœ€æ–°çš„prefetch: ${cardId}(#${prefetchData.previewSentenceNumber})`, 'info');

            const prefetchCard = document.getElementById(cardId);

            if (prefetchCard) {
                // æ·»åŠ è¢«ä¸¢å¼ƒçš„æ ·å¼
                prefetchCard.classList.add('dropped');

                // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºä¸ºè¢«ä¸¢å¼ƒ
                const title = prefetchCard.querySelector('.card-title');
                if (title) {
                    title.textContent = `è½¬å½• #${prefetchData.previewSentenceNumber} [å·²ä¸¢å¼ƒ]`;
                }

                log(`ASR #${prefetchData.previewSentenceNumber} [DROPPED]: "${prefetchData.text}" (é¢„å–è¢«ä¸¢å¼ƒ)`, 'warning');
            } else {
                log(`handleVADDrop: æ‰¾ä¸åˆ°DOMå…ƒç´  ${cardId}`, 'error');
            }

            // ä»å¾…è½¬æ¢åˆ—è¡¨ä¸­ç§»é™¤ï¼ˆä½†ä¿ç•™å¡ç‰‡åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå·²ä¸¢å¼ƒçŠ¶æ€ï¼‰
            prefetchResults.delete(cardId);
            log(`handleVADDrop: ä»prefetchResultsä¸­ç§»é™¤ ${cardId}ï¼Œå‰©ä½™${prefetchResults.size}ä¸ª`, 'info');
        }

        // ç›‘å¬VAD endäº‹ä»¶ï¼Œå¤„ç†prefetchè½¬æ¢
        window.addEventListener('vadEnd', (event) => {
            // å»¶è¿Ÿå¤„ç†VAD endï¼Œç­‰å¾…å¯èƒ½çš„ASR prefetchç»“æœåˆ°è¾¾
            setTimeout(() => {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¾…è½¬æ¢çš„prefetchç»“æœï¼ˆè·å–æœ€æ–°çš„ä¸€ä¸ªï¼‰
                const prefetchEntries = Array.from(prefetchResults.entries());
                log(`vadEnd: (å»¶è¿Ÿå¤„ç†) prefetchResultsä¸­æœ‰${prefetchEntries.length}ä¸ªå¾…è½¬æ¢æ¡ç›®: ${prefetchEntries.map(([id, data]) => `${id}(#${data.previewSentenceNumber})`).join(', ')}`, 'info');

                if (prefetchEntries.length === 0) {
                    log(`vadEnd: æ²¡æœ‰å¾…è½¬æ¢çš„prefetchç»“æœ`, 'info');
                    return;
                }

                processVadEndPrefetch(prefetchEntries);
            }, 200); // ç­‰å¾…200msè®©ASRç»“æœåˆ°è¾¾
        });

        function processVadEndPrefetch(prefetchEntries) {
            // æŒ‰å¡ç‰‡IDæ’åºï¼Œå–æœ€æ–°çš„
            const latestPrefetch = prefetchEntries.sort((a, b) => {
                const aId = parseInt(a[0].split('-')[2]);
                const bId = parseInt(b[0].split('-')[2]);
                return bId - aId;
            })[0];

            const [cardId, prefetchData] = latestPrefetch;
            const prefetchCard = document.getElementById(cardId);

            if (prefetchCard) {
                // åˆ†é…çœŸå®çš„å¥å­åºå·å¹¶å¢åŠ è®¡æ•°å™¨
                const realSentenceNumber = nextSentenceNumber++;

                const finalData = {
                    ...prefetchData,
                    transcriptionNumber: realSentenceNumber
                };

                // å°†prefetchå¡ç‰‡è½¬æ¢ä¸ºæœ€ç»ˆç»“æœå¡ç‰‡
                updateCardForCached(prefetchCard, finalData, cardId);

                // æ›´æ–°å­˜å‚¨çš„æ–‡æœ¬æ˜ å°„
                asrTextMap.set(cardId, prefetchData.text);

                log(`ASR #${realSentenceNumber} [CACHED]: "${prefetchData.text}" (prefetchâ†’æœ€ç»ˆ)`, 'success');

                // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨LLMï¼Œç°åœ¨è°ƒç”¨LLM
                if (autoLLMEnabled) {
                    callLLMForASR(prefetchData.text);
                }
            }

            // æ¸…é™¤å·²è½¬æ¢çš„prefetchç»“æœ
            prefetchResults.delete(cardId);
        }

        // ç›‘å¬ASRç»“æœ
        window.addEventListener('asrResult', (event) => {
            const data = event.detail;
            const container = document.getElementById('asrResults');

            // æ¸…é™¤ç©ºçŠ¶æ€æç¤º
            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            const isPrefetch = data.isPrefetch === true;

            if (isPrefetch) {
                // ä¸ºprefetchç»“æœåˆ†é…é¢„è§ˆçš„å¥å­åºå·å’Œå”¯ä¸€çš„å¡ç‰‡ID
                cardIdCounter++;
                const cardId = `asr-card-${cardIdCounter}`;
                const previewSentenceNumber = nextSentenceNumber;

                const prefetchData = {
                    ...data,
                    previewSentenceNumber: previewSentenceNumber,
                    cardId: cardId
                };

                // å­˜å‚¨prefetchç»“æœ
                prefetchResults.set(cardId, prefetchData);
                createASRCard(prefetchData, cardId, 'prefetch');
                log(`ASR #${previewSentenceNumber} [PREFETCH]: "${data.text}" (cardId: ${cardId}, prefetchResultsæ•°é‡: ${prefetchResults.size})`, 'info');
            } else {
                // é‡æ–°å¤„ç†çš„ç»“æœï¼Œåˆ†é…çœŸå®çš„å¥å­åºå·
                cardIdCounter++;
                const cardId = `asr-card-${cardIdCounter}`;
                const realSentenceNumber = nextSentenceNumber++;

                const finalData = {
                    ...data,
                    transcriptionNumber: realSentenceNumber,
                    cardId: cardId
                };

                createASRCard(finalData, cardId, 'reprocessed');
                log(`ASR #${realSentenceNumber} [REPROCESSED]: "${data.text}"`, 'warning');

                // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨LLMï¼Œè°ƒç”¨LLM
                if (autoLLMEnabled) {
                    callLLMForASR(data.text);
                }
            }
        });

        // åˆ›å»ºASRå¡ç‰‡çš„ç»Ÿä¸€å‡½æ•°
        function createASRCard(data, cardId, type) {
            const container = document.getElementById('asrResults');
            const card = document.createElement('div');
            card.className = `event-card asr-result-card ${type}`;
            card.id = cardId;

            // ä¿å­˜æ–‡æœ¬å†…å®¹å’Œå¯¹åº”çš„ASR prompt
            asrTextMap.set(cardId, data.text);
            asrPromptMap.set(cardId, lastGeneratedASRPrompt || 'æœªä½¿ç”¨ASR Prompt');

            // æ„å»ºæ ‡é¢˜
            let titleSuffix = '';
            switch (type) {
                case 'prefetch': titleSuffix = ' [é¢„å–]'; break;
                case 'cached': titleSuffix = ' [ç¼“å­˜]'; break;
                case 'reprocessed': titleSuffix = ' [é‡å¤„ç†]'; break;
                default: titleSuffix = ''; break;
            }

            let metaInfo = '';
            if (data.performance) {
                const perf = data.performance;
                metaInfo = `
                    <div class="asr-meta">
                        å¤„ç†æ—¶é—´: ${perf.total_processing_ms?.toFixed(0)}ms | 
                        ${perf.provider?.toUpperCase()}: ${perf.api_fetch_ms?.toFixed(0)}ms
                    </div>
                `;
            }

            // ç¡®å®šæ˜¾ç¤ºçš„åºå·
            const displayNumber = data.previewSentenceNumber || data.transcriptionNumber;

            card.innerHTML = `
                <div class="card-header-row">
                    <div class="card-title">è½¬å½• #${displayNumber}${titleSuffix}</div>
                    <button class="asr-prompt-toggle" onclick="toggleASRPrompt('${cardId}')" title="æ˜¾ç¤º/éšè—ASR Prompt">
                        ğŸ“‹
                    </button>
                </div>
                <div class="card-timestamp">æ”¶åˆ°ç»“æœ: ${data.timestamp}</div>
                <div class="card-final-timestamp" style="display: none;">æœ€ç»ˆç¡®è®¤: </div>
                <div class="asr-text" data-card-id="${cardId}">"${data.text}"</div>
                <div class="asr-prompt-section" id="prompt-${cardId}" style="display: none;">
                    <div class="asr-prompt-header">ğŸ¯ ASR Prompt:</div>
                    <div class="asr-prompt-content" id="prompt-content-${cardId}">
                        åŠ è½½ä¸­...
                    </div>
                </div>
                ${metaInfo}
            `;

            setupCardInteractions(card, cardId);
            container.appendChild(card);
            container.scrollTop = container.scrollHeight;
        }

        // æ›´æ–°å¡ç‰‡ä¸ºç¼“å­˜çŠ¶æ€
        function updateCardForCached(card, data, cardId) {
            // æ›´æ–°æ ·å¼
            card.className = 'event-card asr-result-card cached';

            // æ›´æ–°æ ‡é¢˜
            const title = card.querySelector('.card-title');
            title.textContent = `è½¬å½• #${data.transcriptionNumber} [æœ€ç»ˆç»“æœ]`;

            // æ˜¾ç¤ºæœ€ç»ˆç¡®è®¤æ—¶é—´
            const finalTimestamp = card.querySelector('.card-final-timestamp');
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }) + '.' + now.getMilliseconds().toString().padStart(3, '0');
            finalTimestamp.textContent = `æœ€ç»ˆç¡®è®¤: ${timeString}`;
            finalTimestamp.style.display = 'block';

            // æ›´æ–°æ–‡æœ¬å†…å®¹ï¼ˆå¦‚æœä¸åŒï¼‰
            const textElement = card.querySelector('.asr-text');
            const newText = `"${data.text}"`;
            if (textElement.textContent !== newText) {
                textElement.textContent = newText;
                asrTextMap.set(cardId, data.text);
            }

            // æ›´æ–°æ€§èƒ½ä¿¡æ¯
            const existingMeta = card.querySelector('.asr-meta');
            if (existingMeta && data.performance) {
                const perf = data.performance;
                existingMeta.innerHTML = `
                    å¤„ç†æ—¶é—´: ${perf.total_processing_ms?.toFixed(0)}ms | 
                    ${perf.provider?.toUpperCase()}: ${perf.api_fetch_ms?.toFixed(0)}ms
                `;
            }
        }

        // è®¾ç½®å¡ç‰‡äº¤äº’äº‹ä»¶
        function setupCardInteractions(card, cardId) {
            // æ·»åŠ å¡ç‰‡é€‰æ‹©äº‹ä»¶ï¼ˆç‚¹å‡»étoggleæŒ‰é’®åŒºåŸŸï¼‰
            card.onclick = function (e) {
                if (e.target.classList.contains('asr-prompt-toggle') ||
                    e.target.closest('.asr-prompt-section')) {
                    e.stopPropagation();
                    return;
                }
                toggleASRSelection(cardId);
            };
        }

        // åˆ‡æ¢LLMå¡ç‰‡å±•å¼€çŠ¶æ€
        function toggleLLMCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.toggle('expanded');

                // å¹³æ»‘æ»šåŠ¨åˆ°å¡ç‰‡ä½ç½®ï¼ˆå¦‚æœå±•å¼€ï¼‰
                if (card.classList.contains('expanded')) {
                    setTimeout(() => {
                        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 150);
                }
            }
        }

        // åˆ‡æ¢ASR Promptæ˜¾ç¤ºçŠ¶æ€
        function toggleASRPrompt(cardId) {
            const promptSection = document.getElementById(`prompt-${cardId}`);
            const toggleButton = document.querySelector(`[onclick="toggleASRPrompt('${cardId}')"]`);
            const promptContent = document.getElementById(`prompt-content-${cardId}`);

            if (promptSection && toggleButton && promptContent) {
                const isVisible = promptSection.style.display !== 'none';

                if (isVisible) {
                    // éšè—prompt
                    promptSection.style.display = 'none';
                    toggleButton.textContent = 'ğŸ“‹';
                    toggleButton.title = 'æ˜¾ç¤ºASR Prompt';
                } else {
                    // æ˜¾ç¤ºprompt
                    promptSection.style.display = 'block';
                    toggleButton.textContent = 'ğŸ“„';
                    toggleButton.title = 'éšè—ASR Prompt';

                    // åŠ è½½promptå†…å®¹
                    const storedPrompt = asrPromptMap.get(cardId);
                    if (storedPrompt) {
                        promptContent.textContent = storedPrompt;
                    } else {
                        promptContent.textContent = 'æœªæ‰¾åˆ°ASR Promptä¿¡æ¯';
                    }

                    // å¹³æ»‘æ»šåŠ¨åˆ°å¡ç‰‡ä½ç½®
                    setTimeout(() => {
                        promptSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                }
            }
        }

        // æ›´æ–°LLMå†…å®¹çš„å¤„ç†å‡½æ•°
        function updateLLMContent(element) {
            const cardId = element.getAttribute('data-card-id');
            const newContent = element.textContent.trim();

            // æŸ¥æ‰¾å¯¹åº”çš„LLMå“åº”æ•°æ®
            const responseData = llmResponsesData.find(data => data.id === cardId);
            if (responseData) {
                const oldContent = responseData.modifiedProcessedOutput;
                responseData.modifiedProcessedOutput = newContent;

                // åŒæ­¥æ›´æ–°å¡ç‰‡ä¸­çš„ä¸¤ä¸ªç¼–è¾‘åŒºåŸŸ
                syncLLMEditAreas(cardId, newContent);

                // æ›´æ–°ç”¨æˆ·ç•Œé¢å†…å®¹
                updateUserInterfaceContent(oldContent, newContent);

                log(`LLMå†…å®¹å·²ä¿®æ”¹: "${oldContent}" -> "${newContent}"`, 'info');
            }
        }

        // åŒæ­¥LLMå¡ç‰‡ä¸­çš„ä¸¤ä¸ªç¼–è¾‘åŒºåŸŸ
        function syncLLMEditAreas(cardId, newContent) {
            const card = document.getElementById(cardId);
            if (card) {
                const summaryArea = card.querySelector('.llm-processed-output-summary');
                const detailsArea = card.querySelector('.llm-processed-output');

                if (summaryArea && summaryArea.textContent !== newContent) {
                    summaryArea.textContent = newContent;
                }
                if (detailsArea && detailsArea.textContent !== newContent) {
                    detailsArea.textContent = newContent;
                }
            }
        }

        // æ›´æ–°ç”¨æˆ·ç•Œé¢å†…å®¹
        function updateUserInterfaceContent(oldContent, newContent) {
            const userInterfaceTextarea = document.getElementById('userInterface');

            // æ›¿æ¢ç”¨æˆ·ç•Œé¢ä¸­çš„å†…å®¹
            if (userInterfaceContent.includes(oldContent)) {
                userInterfaceContent = userInterfaceContent.replace(oldContent, newContent);
                userInterfaceTextarea.value = userInterfaceContent;
                log(`ç”¨æˆ·ç•Œé¢å†…å®¹å·²æ›´æ–°`, 'success');
            }
        }

        // æš´éœ²å‡½æ•°åˆ°windowå¯¹è±¡ï¼Œä¾›audio_client.jsè°ƒç”¨
        window.processASRPrompt = processASRPrompt;
        window.testTicketField = testTicketField;

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', async () => {
            log('ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–...', 'info');

            // åˆå§‹åŒ–è®¾ç½®
            loadSettings();
            setupSettingsListeners();

            // æ£€æŸ¥ç¯å¢ƒæ”¯æŒ
            if (typeof WebAssembly === 'undefined') {
                log('æµè§ˆå™¨ä¸æ”¯æŒWebAssembly!', 'error');
                return;
            }

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                log('æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å½•åˆ¶!', 'error');
                return;
            }

            // åˆå§‹åŒ– Clerk è®¤è¯ç³»ç»Ÿ
            initializeClerk();

            // è‡ªåŠ¨åˆå§‹åŒ–VAD
            await initVAD();

            // æµ‹è¯•ç¥¨æ®è¾“å…¥æ¡†
            testTicketField();

            log('ç³»ç»Ÿå·²å°±ç»ª', 'success');
            log('å®Œæˆç™»å½•å¹¶è·å–Tokenåå³å¯å¼€å§‹ä½¿ç”¨', 'info');
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (window.audioProcessor) {
                window.audioProcessor.cleanup();
            }
            if (window.globalStreamingVAD) {
                window.globalStreamingVAD.destroy();
            }
        });
    </script>
</body>

</html>